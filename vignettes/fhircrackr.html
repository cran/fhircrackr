<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />


<meta name="date" content="2020-10-19" />

<title>fhircrackr: Handling HL7® FHIR® Resources in R</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">fhircrackr: Handling HL7® FHIR® Resources in R</h1>
<h4 class="date">2020-10-19</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p><code>fhircrackr</code> is a package designed to help analyzing HL7 FHIR<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> resources.</p>
<p>FHIR stands for <em>Fast Healthcare Interoperability Resources</em> and is a standard describing data formats and elements (known as “resources”) as well as an application programming interface (API) for exchanging electronic health records. The standard was created by the Health Level Seven International (HL7) health-care standards organization. For more information on the FHIR standard, visit <a href="https://www.hl7.org/fhir/" class="uri">https://www.hl7.org/fhir/</a>.</p>
<p>While FHIR is a very useful standard to describe and exchange medical data in an interoperable way, it is not at all useful for statistical analyses of data. This is due to the fact that FHIR data is stored in many nested and interlinked resources instead of matrix-like structures.</p>
<p>Thus, to be able to do statistical analyses a tool is needed that allows converting these nested resources into data frames. This process of tabulating FHIR resources is not trivial, as the unpredictable degree of nesting and connectedness of the resources makes generic solutions to this problem not feasible.</p>
<p>We therefore implemented a package that makes it possible to download FHIR resources from a server into R and to tabulate these resources into (multiple) data frames.</p>
<p>The package is still under development. The CRAN version of the package contains all functions that are already stable, for more recent (but potentially unstable) developments, the development version of the package can be downloaded from GitHub using <code>devtools::install_github(&quot;POLAR-fhiR/fhircrackr&quot;)</code>.</p>
<p>This vignette covers the following topics:</p>
<ul>
<li><p>Prerequisites</p></li>
<li><p>Downloading and flattening resources from a FHIR server</p></li>
<li><p>Processing data frames with multiple entries</p></li>
<li><p>Saving and loading downloaded bundles</p></li>
<li><p>Saving and reading designs</p></li>
<li><p>Performance</p></li>
<li><p>Downloading capability statements</p></li>
<li><p>Further options</p></li>
</ul>
</div>
<div id="prerequisites" class="section level2">
<h2>Prerequisites</h2>
<p>The complexity of the problem requires a couple of prerequisites both regarding knowledge and access to data. We will shortly list the preconditions for using the <code>fhircrackr</code> package here:</p>
<ol style="list-style-type: decimal">
<li><p>First of all, you need the endpoint of the FHIR server you want to access. If you don’t have your own FHIR server, you can use one of the available public servers, such as <code>https://hapi.fhir.org/baseR4</code> or <code>http://fhir.hl7.de:8080/baseDstu3</code>. The endpoint of a FHIR server is often referred to as [base] or [baseR4] for the HL7 R4 standard for instance.</p></li>
<li><p>To download resources from the server, you should be familiar with <a href="https://www.hl7.org/fhir/search.html">FHIR search requests</a>. FHIR search allows you to download sets of resources that match very specific requirements. As the focus of this package is dealing with FHIR resources in R rather than the intricacies of FHIR search, we will mostly use simple examples of FHIR search requests. Most of them will have the form <code>[base]/[type]?parameter(s)</code>, where <code>[type]</code> refers to the type of resource you are looking for and <code>parameter(s)</code> characterize specific properties those resources should have. <code>https://hapi.fhir.org/baseR4/Patient?gender=female</code> for example downloads all Patient resources from the FHIR server at <code>https://hapi.fhir.org/baseR4/</code> that represent female patients.</p></li>
<li><p>In the first step, <code>fhircrackr</code> downloads the resources in xml format into R. To specify which elements from the FHIR resources you want in your data frame, you should have at least some familiarity with XPath expressions. A good tutorial on XPath expressions can be found <a href="https://www.w3schools.com/xml/xpath_intro.asp">here</a>.</p></li>
</ol>
<p>In the following we’ll go through a typical workflow with <code>fhircrackr</code> step by step.</p>
</div>
<div id="download-and-flatten-fhir-resources-from-a-server" class="section level2">
<h2>Download and flatten FHIR Resources from a server</h2>
<div id="download-patient-resources" class="section level3">
<h3>1. Download Patient Resources</h3>
<p>We will start with a very simple example and use <code>fhir_search()</code> to download Patient resources from a public HAPI server after we’ve loaded the package with <code>library(fhircrackr)</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(fhircrackr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">patient_bundles &lt;-<span class="st"> </span><span class="kw">fhir_search</span>(<span class="dt">request=</span><span class="st">&quot;http://fhir.hl7.de:8080/baseDstu3/Patient?&quot;</span>,</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">                               <span class="dt">max_bundles=</span><span class="dv">2</span>, <span class="dt">verbose =</span> <span class="dv">0</span>)</a></code></pre></div>
<p>The minimum information <code>fhir_search()</code> requires is a string containing the full FHIR search request in the argument <code>request</code>. In general, a FHIR search request returns a <em>bundle</em> of the resources you requested. If there are a lot of resources matching your request, the search result isn’t returned in one big bundle but distributed over several of them. If the argument <code>max_bundles</code> is set to its default <code>Inf</code>, <code>fhir_search()</code> will return all available bundles, meaning all resources matching your request. If you set it to <code>2</code> as in the example above, the download will stop after the first two bundles. Note that in this case, the result <em>may not contain all</em> the resources from the server matching your request.</p>
<p>If you want to connect to a FHIR server that uses basic authentication, you can supply the arguments <code>username</code> and <code>password</code>.</p>
<p>Because endpoints can sometimes be hard to reach, <code>fhir_search()</code> will start five attempts to connect to the endpoint before it gives up. With the arguments <code>max_attempts</code> and <code>delay_between_attempts</code> you can control this number as well the time interval between attempts.</p>
<p>As you can see in the next block of code, <code>fhir_search()</code> returns a list of xml objects where each list element represents one bundle of resources, so a list of two xml objects in our case:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">length</span>(patient_bundles)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#&gt; [1] 2</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">str</span>(patient_bundles[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">#&gt; List of 2</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#&gt;  $ node:&lt;externalptr&gt; </span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt;  $ doc :&lt;externalptr&gt; </span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt;  - attr(*, &quot;class&quot;)= chr [1:2] &quot;xml_document&quot; &quot;xml_node&quot;</span></a></code></pre></div>
<p>If for some reason you cannot connect to a FHIR server at the moment but want to explore the following functions anyway, the package provides two example lists of bundles containing Patient and MedicationStatement resources. See <code>?patient_bundles</code> and <code>?medication_bundles</code> for how to use them.</p>
</div>
<div id="flatten-fhir-resources" class="section level3">
<h3>2. Flatten FHIR Resources</h3>
<p>Now we know that inside these xml objects there is the patient data somewhere. To get it out, we will use <code>fhir_crack()</code>. The most important argument <code>fhir_crack()</code> takes is <code>bundles</code>, the list of bundles that is returned by <code>fhir_search()</code>. The second important argument is <code>design</code>, an object that tells the function which data to extract from the bundle. <code>fhir_crack()</code> returns a list of data.frames (the default) or a list of data.tables (if argument <code>data.tables=TRUE</code>).</p>
<p>In general, <code>design</code> has to be a named list containing one element per data frame that will be created. We call these elements <em>data.frame descriptions</em>. The names of the data.frame descriptions in <code>design</code> are also going to be the names of the resulting data frames. It usually makes sense to create one data frame per type of resource. Because we have just downloaded resources of the type Patient, the <code>design</code> here would be a list of length 1, containing just one data.frame description. In the following we will first describe the different elements of a data.frame description and will then provide several examples.</p>
<p>The data.frame description itself is again a list, with 3 elements:</p>
<ol style="list-style-type: decimal">
<li><p><em>resource</em><br />
A string containing an XPath expression to the resource you want to extract, e.g. <code>&quot;//Patient&quot;</code>. If your bundles are the result of a regular FHIR search request, the correct XPath expression will always be <code>&quot;//&lt;resource name&gt;&quot;</code>.</p></li>
<li><p><em>cols</em><br />
Can be NULL, a string or a list describing the columns your data frame is going to have.</p></li>
</ol>
<ul>
<li><p>If <em>cols</em> is NULL, all attributes available in the resources will be extracted and put in one column each, the column names will be chosen automatically and reflect the position of the attribute in the resource.</p></li>
<li><p>If <em>cols</em> is a string with an XPath expression indicating a certain level in the bundle, all attributes on this specific level will be extracted. <code>&quot;./*&quot;</code> e.g. will extract all attributes that are located (exactly) one level below the root level given by <code>&quot;//Patient&quot;</code>.</p></li>
<li><p>If <em>cols</em> is a named list of XPath expressions, each element is taken to be the description for one column. <code>family_name = &quot;name/family&quot;</code> for example creates a column named family_name which contains the values for the attribute indicated by the XPath expression <code>&quot;name/family&quot;</code>.</p></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><em>style</em><br />
Can be NULL or a list of length 3 with the following named elements:</li>
</ol>
<ul>
<li><p><em>sep</em>: A string defining the seperator used when multiple entries to the same attribute are pasted together, e.g. <code>&quot;|&quot;</code>.</p></li>
<li><p><em>brackets</em>: Either NULL or a character vector of length 2. If NULL, multiple entries will be pasted together without indices. If character, the two strings provided here are used as brackets for automatically generated indices to sort out multiple entries (see paragraph Multiple Entries). <code>brackets = c(&quot;[&quot;, &quot;]&quot;)</code> e.g. will lead to indices like <code>[1.1]</code>.</p></li>
<li><p><em>rm_empty_cols</em>: Logical. If <code>TRUE</code>, columns containing only <code>NA</code> values will be removed, if <code>FALSE</code>, these columns will be kept.</p></li>
</ul>
<p>All three elements of <code>style</code> can also be controlled directly by the <code>fhir_crack()</code> arguments <code>sep</code>, <code>brackets</code> and <code>remove_empty_columns</code>. If the function arguments are <code>NULL</code> (their default), the values provided in <code>style</code> are used, if they are not NULL, they will overwrite any values in <code>style</code>. If both the function arguments and the <code>style</code> component of the data.frame description are NULL, default values(<code>sep=&quot; &quot;</code>, <code>brackets = NULL</code>, <code>rm_empty_cols=TRUE</code>) will be assumed.</p>
<p>We will now work through examples using designs of different complexity.</p>
<div id="extract-all-available-attributes" class="section level4">
<h4>Extract all available attributes</h4>
<p>Lets start with an example where we only provide the (mandatory) <code>resource</code> component of the data.frame description that is called <code>Patients</code> in our example. In this case, <code>fhir_crack()</code> will extract all available attributes and use default values for the <code>style</code> component:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">#define design</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">design1 &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"> </a>
<a class="sourceLine" id="cb3-4" data-line-number="4">     <span class="dt">Patients =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">   </a>
<a class="sourceLine" id="cb3-6" data-line-number="6">        <span class="dt">resource =</span>  <span class="st">&quot;//Patient&quot;</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">     )</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#Convert resources</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">list_of_tables &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(<span class="dt">bundles =</span> patient_bundles, <span class="dt">design =</span> design1, <span class="dt">verbose =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#have look at part of the results</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">list_of_tables<span class="op">$</span>Patients[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt;     id meta.versionId              meta.lastUpdated text.status   text.div.div</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt; 1 1282              1 2019-03-05T11:33:15.214+01:00   generated hapiHeaderText</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt; 2  267              2 2018-05-13T10:17:40.800+02:00   generated hapiHeaderText</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#&gt; 3  722              1 2018-09-02T17:24:17.083+02:00   generated hapiHeaderText</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">#&gt; 4  731              1 2018-09-02T17:28:16.838+02:00   generated hapiHeaderText</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="co">#&gt; 5  736              1 2018-09-02T17:34:50.955+02:00   generated hapiHeaderText</span></a></code></pre></div>
<p>As you can see, this can easily become a rather wide and sparse data frame. This is due to the fact that every attribute appearing in at least one of the resources will be turned into a variable (i.e. column), even if none of the other resources contain this attribute. For those resources, the value on that attribute will be set to <code>NA</code>. Depending on the variability of the resources, the resulting data frame can contain a lot of <code>NA</code> values. If a resource has multiple entries for an attribute, these entries will pasted together using the string provided in <code>sep</code> as a separator. The column names in this option are automatically generated by pasting together the path to the respective attribute, e.g. <code>name.given.value</code>.</p>
</div>
<div id="extract-all-attributes-at-certain-levels" class="section level4">
<h4>Extract all attributes at certain levels</h4>
<p>We can extract all attributes that are found on a certain level of the resource if we specify this level in an XPath expression and provide it in the <code>cols</code> argument of the data.frame description:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">#define design</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">design2 &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    <span class="dt">Patients =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">   </a>
<a class="sourceLine" id="cb4-6" data-line-number="6">        <span class="dt">resource =</span>  <span class="st">&quot;//Patient&quot;</span>,</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    </a>
<a class="sourceLine" id="cb4-8" data-line-number="8">        <span class="dt">cols =</span> <span class="st">&quot;./*&quot;</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">     )</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">)</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#Convert resources</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">list_of_tables &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(<span class="dt">bundles =</span> patient_bundles, <span class="dt">design =</span> design2, <span class="dt">verbose =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#have look at the results</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="kw">head</span>(list_of_tables<span class="op">$</span>Patients)</a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt;     id  birthDate gender</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; 1 1282       &lt;NA&gt;   &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; 2  267 1960-10-04   &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#&gt; 3  722 1982-01-01   male</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">#&gt; 4  731 1982-01-01   male</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">#&gt; 5  736 1982-01-01   male</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">#&gt; 6  737 1982-01-01   male</span></a></code></pre></div>
<p><code>&quot;./*&quot;</code> tells <code>fhir_crack()</code> to extract all attributes that are located (exactly) one level below the root level. The column names are still automatically generated.</p>
</div>
<div id="extract-specific-attributes" class="section level4">
<h4>Extract specific attributes</h4>
<p>If we know exactly which attributes we want to extract, we can specify them in a named list and provide it in the <code>cols</code> component of the data.frame description:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co">#define design</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">design3 &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="dt">Patients =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">        </a>
<a class="sourceLine" id="cb5-6" data-line-number="6">        <span class="dt">resource =</span> <span class="st">&quot;//Patient&quot;</span>,</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">        </a>
<a class="sourceLine" id="cb5-8" data-line-number="8">        <span class="dt">cols =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">            <span class="dt">PID           =</span> <span class="st">&quot;id&quot;</span>,</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">            <span class="dt">use_name      =</span> <span class="st">&quot;name/use&quot;</span>,</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">            <span class="dt">given_name    =</span> <span class="st">&quot;name/given&quot;</span>,</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">            <span class="dt">family_name   =</span> <span class="st">&quot;name/family&quot;</span>,</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">            <span class="dt">gender        =</span> <span class="st">&quot;gender&quot;</span>,</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">            <span class="dt">birthday      =</span> <span class="st">&quot;birthDate&quot;</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">        )</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">    )</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">)</a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co">#Convert resources</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19">list_of_tables &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(<span class="dt">bundles =</span> patient_bundles, <span class="dt">design =</span> design3, <span class="dt">verbose =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb5-20" data-line-number="20"></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"><span class="co">#have look at the results</span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="kw">head</span>(list_of_tables<span class="op">$</span>Patients)</a>
<a class="sourceLine" id="cb5-23" data-line-number="23"><span class="co">#&gt;    PID use_name given_name family_name gender   birthday</span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24"><span class="co">#&gt; 1 1282 official        Sam     Fhirman   &lt;NA&gt;       &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">#&gt; 2  267     &lt;NA&gt;   Testfall       Nr. 1   &lt;NA&gt; 1960-10-04</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"><span class="co">#&gt; 3  722     &lt;NA&gt;       Rick     Sanchez   male 1982-01-01</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="co">#&gt; 4  731     &lt;NA&gt;       Rick     Sanchez   male 1982-01-01</span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28"><span class="co">#&gt; 5  736     &lt;NA&gt;       Rick     Sanchez   male 1982-01-01</span></a>
<a class="sourceLine" id="cb5-29" data-line-number="29"><span class="co">#&gt; 6  737     &lt;NA&gt;       Rick     Sanchez   male 1982-01-01</span></a></code></pre></div>
<p>This option will usually return the most tidy and clear data frames, because you have full control over the extracted columns including their name in the resulting data frame. You should always extract the resource id, because this is used to link to other resources you might also extract.</p>
<p>If you are not sure which attributes are available or where they are located in the resource, it can be helpful to start by extracting all available attributes. If you are more comfortable with xml, you can also use <code>xml2::xml_structure</code> on one of the bundles from your bundle list, this will print the complete xml structure into your console. Then you can get an overview over the available attributes and their location and continue by doing a second, more targeted extraction to get your final data frame.</p>
</div>
<div id="set-style-component" class="section level4">
<h4>Set <code>style</code> component</h4>
<p>Even though our example won’t show any difference if we change it, here is what a <code>design</code> with a complete data.frame description would look like:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">design4 &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    <span class="dt">Patients =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">        </a>
<a class="sourceLine" id="cb6-5" data-line-number="5">        <span class="dt">resource =</span> <span class="st">&quot;//Patient&quot;</span>,</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">        </a>
<a class="sourceLine" id="cb6-7" data-line-number="7">        <span class="dt">cols =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">            <span class="dt">PID           =</span> <span class="st">&quot;id&quot;</span>,</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">            <span class="dt">use_name      =</span> <span class="st">&quot;name/use&quot;</span>,</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">            <span class="dt">given_name    =</span> <span class="st">&quot;name/given&quot;</span>,</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">            <span class="dt">family_name   =</span> <span class="st">&quot;name/family&quot;</span>,</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">            <span class="dt">gender        =</span> <span class="st">&quot;gender&quot;</span>,</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">            <span class="dt">birthday      =</span> <span class="st">&quot;birthDate&quot;</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">        ),</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">        </a>
<a class="sourceLine" id="cb6-16" data-line-number="16">        <span class="dt">style =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">            <span class="dt">sep =</span> <span class="st">&quot;|&quot;</span>,</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">            <span class="dt">brackets =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>,<span class="st">&quot;]&quot;</span>),</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">            <span class="dt">rm_empty_cols =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20">        )</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">    )</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">)</a></code></pre></div>
<p>The <code>style</code> component will become more important in the example for multiple entries later on.</p>
<p>Internally, <code>fhir_crack()</code> will always complete the <code>design</code> you provided so that it contains <code>resource</code>, <code>cols</code> and <code>style</code> with its elements <code>sep</code>, <code>brackets</code> and <code>rm_empty_cols</code>, even if you left out <code>cols</code> and <code>style</code> completely. You can retrieve the completed <code>design</code> of you last call to <code>fhir_crack()</code> with the function <code>fhir_canonical_design()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">fhir_canonical_design</span>()</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; $Patients</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; $Patients$resource</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; [1] &quot;//Patient&quot;</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; $Patients$cols</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; $Patients$cols$PID</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt; [1] &quot;id/@value&quot;</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt; $Patients$cols$use_name</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt; [1] &quot;name/use/@value&quot;</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt; $Patients$cols$given_name</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co">#&gt; [1] &quot;name/given/@value&quot;</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#&gt; $Patients$cols$family_name</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#&gt; [1] &quot;name/family/@value&quot;</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#&gt; $Patients$cols$gender</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">#&gt; [1] &quot;gender/@value&quot;</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="co">#&gt; $Patients$cols$birthday</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="co">#&gt; [1] &quot;birthDate/@value&quot;</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26"><span class="co">#&gt; $Patients$style</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27"><span class="co">#&gt; $Patients$style$sep</span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28"><span class="co">#&gt; [1] &quot; &quot;</span></a>
<a class="sourceLine" id="cb7-29" data-line-number="29"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-30" data-line-number="30"><span class="co">#&gt; $Patients$style$brackets</span></a>
<a class="sourceLine" id="cb7-31" data-line-number="31"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb7-33" data-line-number="33"><span class="co">#&gt; $Patients$style$rm_empty_cols</span></a>
<a class="sourceLine" id="cb7-34" data-line-number="34"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
</div>
<div id="extract-more-than-one-resource-type" class="section level4">
<h4>Extract more than one resource type</h4>
<p>Of course the previous example is using just one resource type. If you are interested in several types of resources, <code>design</code> will contain several data.frame descriptions and the result will be a list of several data frames.</p>
<p>Consider the following example where we want to download MedicationStatements referring to a certain medication we specify with its SNOMED CT code and also the Patient resources these MedicationStatements are linked to.</p>
<p>When the FHIR search request gets longer, it can be helpful to build up the request piece by piece like this:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">search_request  &lt;-<span class="st"> </span><span class="kw">paste0</span>(</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="st">&quot;https://hapi.fhir.org/baseR4/&quot;</span>, <span class="co">#server endpoint</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="st">&quot;MedicationStatement?&quot;</span>, <span class="co">#look for MedicationsStatements</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="st">&quot;code=http://snomed.info/ct|429374003&quot;</span>, <span class="co">#only choose resources with this snomed code</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="st">&quot;&amp;_include=MedicationStatement:subject&quot;</span>) <span class="co">#include the corresponding Patient resources</span></a></code></pre></div>
<p>Then we can download the resources:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">medication_bundles &lt;-<span class="st"> </span><span class="kw">fhir_search</span>(<span class="dt">request =</span> search_request, <span class="dt">max_bundles =</span> <span class="dv">3</span>)</a></code></pre></div>
<p>Now our <code>design</code> needs two data.frame descriptions (called <code>MedicationStatement</code> and <code>Patients</code> in our example), one for the MedicationStatement resources and one for the Patient resources:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">design &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    <span class="dt">MedicationStatement =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">        <span class="dt">resource =</span> <span class="st">&quot;//MedicationStatement&quot;</span>,</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">        <span class="dt">cols =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">            <span class="dt">MS.ID              =</span> <span class="st">&quot;id&quot;</span>,</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">            <span class="dt">STATUS.TEXT        =</span> <span class="st">&quot;text/status&quot;</span>,</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">            <span class="dt">STATUS             =</span> <span class="st">&quot;status&quot;</span>,</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">            <span class="dt">MEDICATION.SYSTEM  =</span> <span class="st">&quot;medicationCodeableConcept/coding/system&quot;</span>,</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">            <span class="dt">MEDICATION.CODE    =</span> <span class="st">&quot;medicationCodeableConcept/coding/code&quot;</span>,</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">            <span class="dt">MEDICATION.DISPLAY =</span> <span class="st">&quot;medicationCodeableConcept/coding/display&quot;</span>,</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">            <span class="dt">DOSAGE             =</span> <span class="st">&quot;dosage/text&quot;</span>,</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">            <span class="dt">PATIENT            =</span> <span class="st">&quot;subject/reference&quot;</span>,</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">            <span class="dt">LAST.UPDATE        =</span> <span class="st">&quot;meta/lastUpdated&quot;</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">        ),</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">        </a>
<a class="sourceLine" id="cb10-19" data-line-number="19">        <span class="dt">style =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">            <span class="dt">sep =</span> <span class="st">&quot;|&quot;</span>,</a>
<a class="sourceLine" id="cb10-21" data-line-number="21">            <span class="dt">brackets =</span> <span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb10-22" data-line-number="22">            <span class="dt">rm_empty_cols =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23">        )</a>
<a class="sourceLine" id="cb10-24" data-line-number="24">    ),</a>
<a class="sourceLine" id="cb10-25" data-line-number="25"></a>
<a class="sourceLine" id="cb10-26" data-line-number="26">    <span class="dt">Patients =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb10-27" data-line-number="27"></a>
<a class="sourceLine" id="cb10-28" data-line-number="28">        <span class="dt">resource =</span> <span class="st">&quot;//Patient&quot;</span>,</a>
<a class="sourceLine" id="cb10-29" data-line-number="29">        <span class="dt">cols =</span> <span class="st">&quot;./*&quot;</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30">    )</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">)</a></code></pre></div>
<p>In this example, we have spelled out the data.frame description MedicationStatement completely, while we have used a short form for Patients. We can now use this <code>design</code> for <code>fhir_crack()</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">list_of_tables &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(<span class="dt">bundles =</span> medication_bundles, <span class="dt">design =</span> design, <span class="dt">verbose =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw">head</span>(list_of_tables<span class="op">$</span>MedicationStatement)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co">#&gt;   MS.ID STATUS.TEXT STATUS     MEDICATION.SYSTEM MEDICATION.CODE</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt; 1 30233   generated active http://snomed.info/ct       429374003</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt; 2 42012   generated active http://snomed.info/ct       429374003</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt; 3 42091   generated active http://snomed.info/ct       429374003</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; 4 45646   generated active http://snomed.info/ct       429374003</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt; 5 45724   generated active http://snomed.info/ct       429374003</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt; 6 45802   generated active http://snomed.info/ct       429374003</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt;   MEDICATION.DISPLAY           DOSAGE       PATIENT</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co">#&gt; 1   simvastatin 40mg 1 tab once daily Patient/30163</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt; 2   simvastatin 40mg 1 tab once daily Patient/41945</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt; 3   simvastatin 40mg 1 tab once daily Patient/42024</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co">#&gt; 4   simvastatin 40mg 1 tab once daily Patient/45579</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co">#&gt; 5   simvastatin 40mg 1 tab once daily Patient/45657</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co">#&gt; 6   simvastatin 40mg 1 tab once daily Patient/45735</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="co">#&gt;                     LAST.UPDATE</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"><span class="co">#&gt; 1 2019-09-26T14:34:44.543+00:00</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">#&gt; 2 2019-10-09T20:12:49.778+00:00</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="co">#&gt; 3 2019-10-09T22:44:05.728+00:00</span></a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="co">#&gt; 4 2019-10-11T16:17:42.365+00:00</span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="co">#&gt; 5 2019-10-11T16:30:24.411+00:00</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="co">#&gt; 6 2019-10-11T16:32:05.206+00:00</span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25"></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="kw">head</span>(list_of_tables<span class="op">$</span>Patients)</a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="co">#&gt;      id gender  birthDate</span></a>
<a class="sourceLine" id="cb11-28" data-line-number="28"><span class="co">#&gt; 1 60096   male 2019-11-13</span></a>
<a class="sourceLine" id="cb11-29" data-line-number="29"><span class="co">#&gt; 2 49443 female 1970-10-19</span></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="co">#&gt; 3 46213 female 2019-10-11</span></a>
<a class="sourceLine" id="cb11-31" data-line-number="31"><span class="co">#&gt; 4 45735   male 1970-10-11</span></a>
<a class="sourceLine" id="cb11-32" data-line-number="32"><span class="co">#&gt; 5 42024 female 1979-10-09</span></a>
<a class="sourceLine" id="cb11-33" data-line-number="33"><span class="co">#&gt; 6 58504   male 2019-11-08</span></a></code></pre></div>
<p>As you can see, the result now contains two data frames, one for Patient resources and one for MedicationStatement resources.</p>
</div>
</div>
<div id="multiple-entries" class="section level3">
<h3>3. Multiple entries</h3>
<p>A particularly complicated problem in flattening FHIR resources is caused by the fact that there can be multiple entries to an attribute. The profile according to which your FHIR resources have been built defines how often a particular attribute can appear in a resource. This is called the <em>cardinality</em> of the attribute. For example the Patient resource defined <a href="https://www.hl7.org/fhir/patient.html#resource">here</a> can have zero or one birthdates but arbitrarily many addresses. In general, <code>fhir_crack()</code> will paste multiple entries for the same attribute together in the data frame, using the separator provided by the <code>sep</code> argument. In most cases this will work just fine, but there are some special cases that require a little more attention.</p>
<p>Let’s have a look at the following example, where we have a bundle containing just three Patient resources:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">bundle &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">read_xml</span>(</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">    <span class="st">&quot;&lt;Bundle&gt;</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">        &lt;Patient&gt;</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="st">            &lt;id value='id1'/&gt;</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">            &lt;address&gt;</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">                &lt;use value='home'/&gt;</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">                &lt;city value='Amsterdam'/&gt;</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="st">                &lt;type value='physical'/&gt;</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">                &lt;country value='Netherlands'/&gt;</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="st">            &lt;/address&gt;</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="st">            &lt;birthDate value='1992-02-06'/&gt;</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="st">        &lt;/Patient&gt;</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="st">        &lt;Patient&gt;</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="st">            &lt;id value='id2'/&gt;</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="st">            &lt;address&gt;</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="st">                &lt;use value='home'/&gt;</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="st">                &lt;city value='Rome'/&gt;</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="st">                &lt;type value='physical'/&gt;</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="st">                &lt;country value='Italy'/&gt;</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="st">            &lt;/address&gt;</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="st">            &lt;address&gt;</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="st">                &lt;use value='work'/&gt;</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="st">                &lt;city value='Stockholm'/&gt;</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="st">                &lt;type value='postal'/&gt;</span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27"><span class="st">                &lt;country value='Sweden'/&gt;</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="st">            &lt;/address&gt;          </span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="st">            &lt;birthDate value='1980-05-23'/&gt;</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="st">        &lt;/Patient&gt;</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"></a>
<a class="sourceLine" id="cb12-32" data-line-number="32"><span class="st">        &lt;Patient&gt;</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="st">            &lt;id value='id3.1'/&gt;</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="st">            &lt;id value='id3.2'/&gt;</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="st">            &lt;address&gt;</span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36"><span class="st">                &lt;use value='home'/&gt;</span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37"><span class="st">                &lt;city value='Berlin'/&gt;</span></a>
<a class="sourceLine" id="cb12-38" data-line-number="38"><span class="st">            &lt;/address&gt;</span></a>
<a class="sourceLine" id="cb12-39" data-line-number="39"><span class="st">            &lt;address&gt;</span></a>
<a class="sourceLine" id="cb12-40" data-line-number="40"><span class="st">                &lt;type value='postal'/&gt;</span></a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="st">                &lt;country value='France'/&gt;</span></a>
<a class="sourceLine" id="cb12-42" data-line-number="42"><span class="st">            &lt;/address&gt;</span></a>
<a class="sourceLine" id="cb12-43" data-line-number="43"><span class="st">            &lt;address&gt;</span></a>
<a class="sourceLine" id="cb12-44" data-line-number="44"><span class="st">                &lt;use value='work'/&gt;</span></a>
<a class="sourceLine" id="cb12-45" data-line-number="45"><span class="st">                &lt;city value='London'/&gt;</span></a>
<a class="sourceLine" id="cb12-46" data-line-number="46"><span class="st">                &lt;type value='postal'/&gt;</span></a>
<a class="sourceLine" id="cb12-47" data-line-number="47"><span class="st">                &lt;country value='England'/&gt;</span></a>
<a class="sourceLine" id="cb12-48" data-line-number="48"><span class="st">            &lt;/address&gt;</span></a>
<a class="sourceLine" id="cb12-49" data-line-number="49"><span class="st">            &lt;birthDate value='1974-12-25'/&gt;</span></a>
<a class="sourceLine" id="cb12-50" data-line-number="50"><span class="st">        &lt;/Patient&gt;      </span></a>
<a class="sourceLine" id="cb12-51" data-line-number="51"></a>
<a class="sourceLine" id="cb12-52" data-line-number="52"><span class="st">    &lt;/Bundle&gt;&quot;</span></a>
<a class="sourceLine" id="cb12-53" data-line-number="53">)</a>
<a class="sourceLine" id="cb12-54" data-line-number="54"></a>
<a class="sourceLine" id="cb12-55" data-line-number="55">bundle_list &lt;-<span class="st"> </span><span class="kw">list</span>(bundle)</a></code></pre></div>
<p>This bundle contains three Patient resources. The first resource has just one entry for the address attribute. The second Patient resource has two entries containing the same elements for the address attribute. The third Patient resource has a rather messy address attribute, with three entries containing different elements and also two entries for the id attribute.</p>
<p>Let’s see what happens if we extract all attributes:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">design1 &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">    <span class="dt">Patients =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">        <span class="dt">resource =</span> <span class="st">&quot;//Patient&quot;</span>,</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">        <span class="dt">cols =</span> <span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb13-5" data-line-number="5">        <span class="dt">style =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">            <span class="dt">sep =</span> <span class="st">&quot; | &quot;</span>,</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">            <span class="dt">brackets  =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">            <span class="dt">rm_empty_cols =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9">        )</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">    )</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">df1 &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(<span class="dt">bundles =</span> bundle_list, <span class="dt">design =</span> design1, <span class="dt">verbose =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">df1<span class="op">$</span>Patients</a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt;              id address.use     address.city      address.type  address.country</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt; 1           id1        home        Amsterdam          physical      Netherlands</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#&gt; 2           id2 home | work Rome | Stockholm physical | postal   Italy | Sweden</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co">#&gt; 3 id3.1 | id3.2 home | work  Berlin | London   postal | postal France | England</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="co">#&gt;    birthDate</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="co">#&gt; 1 1992-02-06</span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="co">#&gt; 2 1980-05-23</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22"><span class="co">#&gt; 3 1974-12-25</span></a></code></pre></div>
<p>As you can see, multiple entries for the same attribute (address and id) are pasted together. This works fine for Patient 2, but for Patient 3 you can see a problem with the number of entries that are displayed. The original Patient resource had <em>three</em> (incomplete) <code>address</code> entries, but because the first two of them use complementary elements (<code>use</code> and <code>city</code> vs. <code>type</code> and <code>country</code>), the resulting pasted entries look like there had just been two entries for the <code>address</code> attribute.</p>
<p>You can counter this problem by setting <code>brackets</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">design2 &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">    <span class="dt">Patients =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">        <span class="dt">resource =</span> <span class="st">&quot;//Patient&quot;</span>,</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">        <span class="dt">cols =</span> <span class="ot">NULL</span>, </a>
<a class="sourceLine" id="cb14-5" data-line-number="5">        <span class="dt">style =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">            <span class="dt">sep =</span> <span class="st">&quot; | &quot;</span>,</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">            <span class="dt">brackets  =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>, <span class="st">&quot;]&quot;</span>),</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">            <span class="dt">rm_empty_cols =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">        )</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">    )</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb14-12" data-line-number="12"></a>
<a class="sourceLine" id="cb14-13" data-line-number="13">df2 &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(<span class="dt">bundles =</span> bundle_list, <span class="dt">design =</span> design2, <span class="dt">verbose =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">df2<span class="op">$</span>Patients</a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co">#&gt;                    id           address.use               address.city</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="co">#&gt; 1              [1]id1             [1.1]home             [1.1]Amsterdam</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="co">#&gt; 2              [1]id2 [1.1]home | [2.1]work [1.1]Rome | [2.1]Stockholm</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="co">#&gt; 3 [1]id3.1 | [2]id3.2 [1.1]home | [3.1]work  [1.1]Berlin | [3.1]London</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="co">#&gt;                  address.type            address.country     birthDate</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="co">#&gt; 1               [1.1]physical           [1.1]Netherlands [1]1992-02-06</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="co">#&gt; 2 [1.1]physical | [2.1]postal   [1.1]Italy | [2.1]Sweden [1]1980-05-23</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="co">#&gt; 3   [2.1]postal | [3.1]postal [2.1]France | [3.1]England [1]1974-12-25</span></a></code></pre></div>
<p>Now the indices display the entry the value belongs to. That way you can see that Patient resource 3 had three entries for the attribute <code>address</code> and you can also see which attributes belong to which entry.</p>
<p>It is possible to set the <code>style</code> separately for every data.frame description you have. If you want to have the same style specifications for all the data frames, you can supply them in as function arguments to <code>fhir_crack()</code>. The values provided there will be automatically filled in in the design, as you can see, when you check with <code>fhir_canonical_design()</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">design3 &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">    <span class="dt">Patients =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">        <span class="dt">resource =</span> <span class="st">&quot;//Patient&quot;</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">    )</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6"></a>
<a class="sourceLine" id="cb15-7" data-line-number="7">df3 &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(<span class="dt">bundles =</span> bundle_list, </a>
<a class="sourceLine" id="cb15-8" data-line-number="8">                  <span class="dt">design =</span> design3, </a>
<a class="sourceLine" id="cb15-9" data-line-number="9">                  <span class="dt">sep =</span> <span class="st">&quot; | &quot;</span>, </a>
<a class="sourceLine" id="cb15-10" data-line-number="10">                  <span class="dt">brackets =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>, <span class="st">&quot;]&quot;</span>))</a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co">#&gt;  Patients</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="co">#&gt;  1...</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="co">#&gt; FHIR-Resources cracked.</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"></a>
<a class="sourceLine" id="cb15-17" data-line-number="17">df3<span class="op">$</span>Patients</a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="co">#&gt;                    id           address.use               address.city</span></a>
<a class="sourceLine" id="cb15-19" data-line-number="19"><span class="co">#&gt; 1              [1]id1             [1.1]home             [1.1]Amsterdam</span></a>
<a class="sourceLine" id="cb15-20" data-line-number="20"><span class="co">#&gt; 2              [1]id2 [1.1]home | [2.1]work [1.1]Rome | [2.1]Stockholm</span></a>
<a class="sourceLine" id="cb15-21" data-line-number="21"><span class="co">#&gt; 3 [1]id3.1 | [2]id3.2 [1.1]home | [3.1]work  [1.1]Berlin | [3.1]London</span></a>
<a class="sourceLine" id="cb15-22" data-line-number="22"><span class="co">#&gt;                  address.type            address.country     birthDate</span></a>
<a class="sourceLine" id="cb15-23" data-line-number="23"><span class="co">#&gt; 1               [1.1]physical           [1.1]Netherlands [1]1992-02-06</span></a>
<a class="sourceLine" id="cb15-24" data-line-number="24"><span class="co">#&gt; 2 [1.1]physical | [2.1]postal   [1.1]Italy | [2.1]Sweden [1]1980-05-23</span></a>
<a class="sourceLine" id="cb15-25" data-line-number="25"><span class="co">#&gt; 3   [2.1]postal | [3.1]postal [2.1]France | [3.1]England [1]1974-12-25</span></a>
<a class="sourceLine" id="cb15-26" data-line-number="26"></a>
<a class="sourceLine" id="cb15-27" data-line-number="27"></a>
<a class="sourceLine" id="cb15-28" data-line-number="28"><span class="kw">fhir_canonical_design</span>()</a>
<a class="sourceLine" id="cb15-29" data-line-number="29"><span class="co">#&gt; $Patients</span></a>
<a class="sourceLine" id="cb15-30" data-line-number="30"><span class="co">#&gt; $Patients$resource</span></a>
<a class="sourceLine" id="cb15-31" data-line-number="31"><span class="co">#&gt; [1] &quot;//Patient&quot;</span></a>
<a class="sourceLine" id="cb15-32" data-line-number="32"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-33" data-line-number="33"><span class="co">#&gt; $Patients$cols</span></a>
<a class="sourceLine" id="cb15-34" data-line-number="34"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb15-35" data-line-number="35"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-36" data-line-number="36"><span class="co">#&gt; $Patients$style</span></a>
<a class="sourceLine" id="cb15-37" data-line-number="37"><span class="co">#&gt; $Patients$style$sep</span></a>
<a class="sourceLine" id="cb15-38" data-line-number="38"><span class="co">#&gt; [1] &quot; | &quot;</span></a>
<a class="sourceLine" id="cb15-39" data-line-number="39"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-40" data-line-number="40"><span class="co">#&gt; $Patients$style$brackets</span></a>
<a class="sourceLine" id="cb15-41" data-line-number="41"><span class="co">#&gt; [1] &quot;[&quot; &quot;]&quot;</span></a>
<a class="sourceLine" id="cb15-42" data-line-number="42"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb15-43" data-line-number="43"><span class="co">#&gt; $Patients$style$rm_empty_cols</span></a>
<a class="sourceLine" id="cb15-44" data-line-number="44"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
<p>Of course the above example is a very specific case that only occurs if your resources have multiple entries with complementary elements. In the vast majority of cases multiple entries in one resource will have the same structure, thus making numbering of those entries superfluous.</p>
</div>
</div>
<div id="process-data-frames-with-multiple-entries" class="section level2">
<h2>Process Data Frames with multiple Entries</h2>
<div id="melt-data-frames-with-multiple-entries" class="section level3">
<h3>1. Melt data frames with multiple entries</h3>
<p>If the data frame produced by <code>fhir_crack()</code> contains multiple entries, you’ll probably want to divide these entries into distinct observations at some point. This is where <code>fhir_melt()</code> comes into play. <code>fhir_melt()</code> takes an indexed data frame with multiple entries in one or several <code>columns</code> and spreads (aka melts) these entries over several rows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">fhir_melt</span>(df2<span class="op">$</span>Patients, <span class="dt">columns =</span> <span class="st">&quot;address.city&quot;</span>, <span class="dt">brackets =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>,<span class="st">&quot;]&quot;</span>), </a>
<a class="sourceLine" id="cb16-2" data-line-number="2">          <span class="dt">sep=</span><span class="st">&quot; | &quot;</span>, <span class="dt">all_columns =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">#&gt;   address.city id_name</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co">#&gt; 1 [1]Amsterdam       1</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co">#&gt; 2      [1]Rome       2</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co">#&gt; 3 [1]Stockholm       2</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt; 4    [1]Berlin       3</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co">#&gt; 5    [1]London       3</span></a></code></pre></div>
<p>The new variable <code>resource_identifier</code> maps which rows in the created data frame belong to which row (usually equivalent to one resource) in the original data frame. <code>brackets</code> and <code>sep</code> should be given the same character vectors that have been used to build the indices in <code>fhir_melt()</code>. <code>columns</code> is a character vector with the names of the variables you want to melt. You can provide more than one column here but it makes sense to only have variables from the same repeating attribute together in one call to <code>fhir_melt()</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;address.city&quot;</span>, <span class="st">&quot;address.use&quot;</span>, <span class="st">&quot;address.type&quot;</span>, </a>
<a class="sourceLine" id="cb17-2" data-line-number="2">          <span class="st">&quot;address.country&quot;</span>)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="kw">fhir_melt</span>(df2<span class="op">$</span>Patients, <span class="dt">columns =</span> cols, <span class="dt">brackets =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>,<span class="st">&quot;]&quot;</span>), </a>
<a class="sourceLine" id="cb17-5" data-line-number="5">          <span class="dt">sep=</span><span class="st">&quot; | &quot;</span>, <span class="dt">all_columns =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co">#&gt;    address.city address.use address.type address.country id_name</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co">#&gt; 1: [1]Amsterdam     [1]home  [1]physical  [1]Netherlands       1</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="co">#&gt; 2:      [1]Rome     [1]home  [1]physical        [1]Italy       2</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co">#&gt; 3: [1]Stockholm     [1]work    [1]postal       [1]Sweden       2</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="co">#&gt; 4:    [1]Berlin     [1]home         &lt;NA&gt;            &lt;NA&gt;       3</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="co">#&gt; 5:    [1]London     [1]work    [1]postal      [1]England       3</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12"><span class="co">#&gt; 6:         &lt;NA&gt;        &lt;NA&gt;    [1]postal       [1]France       3</span></a></code></pre></div>
<p>If the names of the variables in your data frame have been generated automatically with <code>fhir_crack()</code> you can find all variable names belonging to the same attribute with <code>fhir_common_columns()</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">cols &lt;-<span class="st"> </span><span class="kw">fhir_common_columns</span>(df2<span class="op">$</span>Patients, <span class="dt">column_names_prefix =</span> <span class="st">&quot;address&quot;</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">cols</a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co">#&gt; [1] &quot;address.use&quot;     &quot;address.city&quot;    &quot;address.type&quot;    &quot;address.country&quot;</span></a></code></pre></div>
<p>With the argument <code>all_columns</code> you can control whether the resulting data frame contains only the molten columns or all columns of the original data frame:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw">fhir_melt</span>(df2<span class="op">$</span>Patients, <span class="dt">columns =</span> cols, <span class="dt">brackets =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>,<span class="st">&quot;]&quot;</span>), </a>
<a class="sourceLine" id="cb19-2" data-line-number="2">          <span class="dt">sep=</span><span class="st">&quot; | &quot;</span>, <span class="dt">all_columns =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="co">#&gt;                     id address.use address.city address.type address.country</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="co">#&gt; 1:              [1]id1     [1]home [1]Amsterdam  [1]physical  [1]Netherlands</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co">#&gt; 2:              [1]id2     [1]home      [1]Rome  [1]physical        [1]Italy</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="co">#&gt; 3:              [1]id2     [1]work [1]Stockholm    [1]postal       [1]Sweden</span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="co">#&gt; 4: [1]id3.1 | [2]id3.2     [1]home    [1]Berlin         &lt;NA&gt;            &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="co">#&gt; 5: [1]id3.1 | [2]id3.2     [1]work    [1]London    [1]postal      [1]England</span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="co">#&gt; 6: [1]id3.1 | [2]id3.2        &lt;NA&gt;         &lt;NA&gt;    [1]postal       [1]France</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10"><span class="co">#&gt;        birthDate id_name</span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11"><span class="co">#&gt; 1: [1]1992-02-06       1</span></a>
<a class="sourceLine" id="cb19-12" data-line-number="12"><span class="co">#&gt; 2: [1]1980-05-23       2</span></a>
<a class="sourceLine" id="cb19-13" data-line-number="13"><span class="co">#&gt; 3: [1]1980-05-23       2</span></a>
<a class="sourceLine" id="cb19-14" data-line-number="14"><span class="co">#&gt; 4: [1]1974-12-25       3</span></a>
<a class="sourceLine" id="cb19-15" data-line-number="15"><span class="co">#&gt; 5: [1]1974-12-25       3</span></a>
<a class="sourceLine" id="cb19-16" data-line-number="16"><span class="co">#&gt; 6: [1]1974-12-25       3</span></a></code></pre></div>
<p>Values on the other variables will just repeat in the newly created rows.</p>
<p>If you try to melt several variables that don’t belong to the same attribute in one call to <code>fhir_melt()</code>, this will cause problems, because the different attributes won’t be combined correctly:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">cols &lt;-<span class="st"> </span><span class="kw">c</span>(cols, <span class="st">&quot;id&quot;</span>)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="kw">fhir_melt</span>(df2<span class="op">$</span>Patients, <span class="dt">columns =</span> cols, <span class="dt">brackets =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>,<span class="st">&quot;]&quot;</span>), </a>
<a class="sourceLine" id="cb20-3" data-line-number="3">          <span class="dt">sep=</span><span class="st">&quot; | &quot;</span>, <span class="dt">all_columns =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="co">#&gt;         id address.use address.city address.type address.country     birthDate</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="co">#&gt; 1:   []id1     [1]home [1]Amsterdam  [1]physical  [1]Netherlands [1]1992-02-06</span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="co">#&gt; 2:   []id2     [1]home      [1]Rome  [1]physical        [1]Italy [1]1980-05-23</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="co">#&gt; 3:    &lt;NA&gt;     [1]work [1]Stockholm    [1]postal       [1]Sweden [1]1980-05-23</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="co">#&gt; 4: []id3.1     [1]home    [1]Berlin         &lt;NA&gt;            &lt;NA&gt; [1]1974-12-25</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="co">#&gt; 5:    &lt;NA&gt;     [1]work    [1]London    [1]postal      [1]England [1]1974-12-25</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="co">#&gt; 6: []id3.2        &lt;NA&gt;         &lt;NA&gt;    [1]postal       [1]France [1]1974-12-25</span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="co">#&gt;    id_name</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="co">#&gt; 1:       1</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="co">#&gt; 2:       2</span></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="co">#&gt; 3:       2</span></a>
<a class="sourceLine" id="cb20-15" data-line-number="15"><span class="co">#&gt; 4:       3</span></a>
<a class="sourceLine" id="cb20-16" data-line-number="16"><span class="co">#&gt; 5:       3</span></a>
<a class="sourceLine" id="cb20-17" data-line-number="17"><span class="co">#&gt; 6:       3</span></a></code></pre></div>
<p>Instead, melt the attributes one after another:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">cols &lt;-<span class="st"> </span><span class="kw">fhir_common_columns</span>(df2<span class="op">$</span>Patients, <span class="st">&quot;address&quot;</span>)</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">molten_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">fhir_melt</span>(df2<span class="op">$</span>Patients, <span class="dt">columns =</span> cols, <span class="dt">brackets =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>,<span class="st">&quot;]&quot;</span>), </a>
<a class="sourceLine" id="cb21-4" data-line-number="4">                      <span class="dt">sep=</span><span class="st">&quot; | &quot;</span>, <span class="dt">all_columns =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">molten_<span class="dv">1</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="co">#&gt;                     id address.use address.city address.type address.country</span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="co">#&gt; 1:              [1]id1     [1]home [1]Amsterdam  [1]physical  [1]Netherlands</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="co">#&gt; 2:              [1]id2     [1]home      [1]Rome  [1]physical        [1]Italy</span></a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="co">#&gt; 3:              [1]id2     [1]work [1]Stockholm    [1]postal       [1]Sweden</span></a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="co">#&gt; 4: [1]id3.1 | [2]id3.2     [1]home    [1]Berlin         &lt;NA&gt;            &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="co">#&gt; 5: [1]id3.1 | [2]id3.2     [1]work    [1]London    [1]postal      [1]England</span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="co">#&gt; 6: [1]id3.1 | [2]id3.2        &lt;NA&gt;         &lt;NA&gt;    [1]postal       [1]France</span></a>
<a class="sourceLine" id="cb21-13" data-line-number="13"><span class="co">#&gt;        birthDate id_name</span></a>
<a class="sourceLine" id="cb21-14" data-line-number="14"><span class="co">#&gt; 1: [1]1992-02-06       1</span></a>
<a class="sourceLine" id="cb21-15" data-line-number="15"><span class="co">#&gt; 2: [1]1980-05-23       2</span></a>
<a class="sourceLine" id="cb21-16" data-line-number="16"><span class="co">#&gt; 3: [1]1980-05-23       2</span></a>
<a class="sourceLine" id="cb21-17" data-line-number="17"><span class="co">#&gt; 4: [1]1974-12-25       3</span></a>
<a class="sourceLine" id="cb21-18" data-line-number="18"><span class="co">#&gt; 5: [1]1974-12-25       3</span></a>
<a class="sourceLine" id="cb21-19" data-line-number="19"><span class="co">#&gt; 6: [1]1974-12-25       3</span></a>
<a class="sourceLine" id="cb21-20" data-line-number="20"></a>
<a class="sourceLine" id="cb21-21" data-line-number="21">molten_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">fhir_melt</span>(molten_<span class="dv">1</span>, <span class="dt">columns =</span> <span class="st">&quot;id&quot;</span>, <span class="dt">brackets =</span> <span class="kw">c</span>(<span class="st">&quot;[&quot;</span>,<span class="st">&quot;]&quot;</span>), </a>
<a class="sourceLine" id="cb21-22" data-line-number="22">                      <span class="dt">sep=</span><span class="st">&quot; | &quot;</span>, <span class="dt">all_columns =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb21-23" data-line-number="23">molten_<span class="dv">2</span></a>
<a class="sourceLine" id="cb21-24" data-line-number="24"><span class="co">#&gt;         id address.use address.city address.type address.country     birthDate</span></a>
<a class="sourceLine" id="cb21-25" data-line-number="25"><span class="co">#&gt; 1:   []id1     [1]home [1]Amsterdam  [1]physical  [1]Netherlands [1]1992-02-06</span></a>
<a class="sourceLine" id="cb21-26" data-line-number="26"><span class="co">#&gt; 2:   []id2     [1]home      [1]Rome  [1]physical        [1]Italy [1]1980-05-23</span></a>
<a class="sourceLine" id="cb21-27" data-line-number="27"><span class="co">#&gt; 3:   []id2     [1]work [1]Stockholm    [1]postal       [1]Sweden [1]1980-05-23</span></a>
<a class="sourceLine" id="cb21-28" data-line-number="28"><span class="co">#&gt; 4: []id3.1     [1]home    [1]Berlin         &lt;NA&gt;            &lt;NA&gt; [1]1974-12-25</span></a>
<a class="sourceLine" id="cb21-29" data-line-number="29"><span class="co">#&gt; 5: []id3.2     [1]home    [1]Berlin         &lt;NA&gt;            &lt;NA&gt; [1]1974-12-25</span></a>
<a class="sourceLine" id="cb21-30" data-line-number="30"><span class="co">#&gt; 6: []id3.1     [1]work    [1]London    [1]postal      [1]England [1]1974-12-25</span></a>
<a class="sourceLine" id="cb21-31" data-line-number="31"><span class="co">#&gt; 7: []id3.2     [1]work    [1]London    [1]postal      [1]England [1]1974-12-25</span></a>
<a class="sourceLine" id="cb21-32" data-line-number="32"><span class="co">#&gt; 8: []id3.1        &lt;NA&gt;         &lt;NA&gt;    [1]postal       [1]France [1]1974-12-25</span></a>
<a class="sourceLine" id="cb21-33" data-line-number="33"><span class="co">#&gt; 9: []id3.2        &lt;NA&gt;         &lt;NA&gt;    [1]postal       [1]France [1]1974-12-25</span></a>
<a class="sourceLine" id="cb21-34" data-line-number="34"><span class="co">#&gt;    id_name</span></a>
<a class="sourceLine" id="cb21-35" data-line-number="35"><span class="co">#&gt; 1:       1</span></a>
<a class="sourceLine" id="cb21-36" data-line-number="36"><span class="co">#&gt; 2:       2</span></a>
<a class="sourceLine" id="cb21-37" data-line-number="37"><span class="co">#&gt; 3:       3</span></a>
<a class="sourceLine" id="cb21-38" data-line-number="38"><span class="co">#&gt; 4:       4</span></a>
<a class="sourceLine" id="cb21-39" data-line-number="39"><span class="co">#&gt; 5:       4</span></a>
<a class="sourceLine" id="cb21-40" data-line-number="40"><span class="co">#&gt; 6:       5</span></a>
<a class="sourceLine" id="cb21-41" data-line-number="41"><span class="co">#&gt; 7:       5</span></a>
<a class="sourceLine" id="cb21-42" data-line-number="42"><span class="co">#&gt; 8:       6</span></a>
<a class="sourceLine" id="cb21-43" data-line-number="43"><span class="co">#&gt; 9:       6</span></a></code></pre></div>
<p>This will give you the appropriate cross product of all multiple entries.</p>
</div>
<div id="remove-indices" class="section level3">
<h3>2. Remove indices</h3>
<p>Once you have sorted out the multiple entries, you might want to get rid of the indices in your data.frame. This can be achieved using <code>fhir_rm_indices()</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">fhir_rm_indices</span>(molten_<span class="dv">2</span>, <span class="dt">brackets=</span><span class="kw">c</span>(<span class="st">&quot;[&quot;</span>,<span class="st">&quot;]&quot;</span>))</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="co">#&gt;       id address.use address.city address.type address.country  birthDate</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="co">#&gt; 1:   id1        home    Amsterdam     physical     Netherlands 1992-02-06</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co">#&gt; 2:   id2        home         Rome     physical           Italy 1980-05-23</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="co">#&gt; 3:   id2        work    Stockholm       postal          Sweden 1980-05-23</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="co">#&gt; 4: id3.1        home       Berlin         &lt;NA&gt;            &lt;NA&gt; 1974-12-25</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="co">#&gt; 5: id3.2        home       Berlin         &lt;NA&gt;            &lt;NA&gt; 1974-12-25</span></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="co">#&gt; 6: id3.1        work       London       postal         England 1974-12-25</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="co">#&gt; 7: id3.2        work       London       postal         England 1974-12-25</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="co">#&gt; 8: id3.1        &lt;NA&gt;         &lt;NA&gt;       postal          France 1974-12-25</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="co">#&gt; 9: id3.2        &lt;NA&gt;         &lt;NA&gt;       postal          France 1974-12-25</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="co">#&gt;    id_name</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="co">#&gt; 1:       1</span></a>
<a class="sourceLine" id="cb22-14" data-line-number="14"><span class="co">#&gt; 2:       2</span></a>
<a class="sourceLine" id="cb22-15" data-line-number="15"><span class="co">#&gt; 3:       3</span></a>
<a class="sourceLine" id="cb22-16" data-line-number="16"><span class="co">#&gt; 4:       4</span></a>
<a class="sourceLine" id="cb22-17" data-line-number="17"><span class="co">#&gt; 5:       4</span></a>
<a class="sourceLine" id="cb22-18" data-line-number="18"><span class="co">#&gt; 6:       5</span></a>
<a class="sourceLine" id="cb22-19" data-line-number="19"><span class="co">#&gt; 7:       5</span></a>
<a class="sourceLine" id="cb22-20" data-line-number="20"><span class="co">#&gt; 8:       6</span></a>
<a class="sourceLine" id="cb22-21" data-line-number="21"><span class="co">#&gt; 9:       6</span></a></code></pre></div>
<p>Again, <code>brackets</code> and <code>sep</code> should be given the same character vector that was used for <code>fhir_crack()</code> and <code>fhir_melt()</code>respectively.</p>
</div>
</div>
<div id="save-and-load-downloaded-bundles" class="section level2">
<h2>Save and load downloaded bundles</h2>
<p>Since <code>fhir_crack()</code> discards of all the data not specified in <code>design</code>, it makes sense to store the original search result for reproducibility and in case you realize later on that you need elements from the resources that you haven’t extracted at first.</p>
<p>There are two ways of saving the FHIR bundles you downloaded: Either you save them as R objects, or you write them to an xml file.</p>
<div id="save-and-load-bundles-as-r-objects" class="section level3">
<h3>1. Save and load bundles as R objects</h3>
<p>If you want to save the list of downloaded bundles as an <code>.rda</code> or <code>.RData</code> file, you can’t just use R’s <code>save()</code> or <code>save_image()</code> on it, because this will break the external pointers in the xml objects representing your bundles. Instead, you have to serialize the bundles before saving and unserialize them after loading. For single xml objects the package <code>xml2</code> provides serialization functions. For convenience, however, <code>fhircrackr</code> provides the functions <code>fhir_serialize()</code> and <code>fhir_unserialize()</code> that can be used directly on the list of bundles returned by <code>fhir_search()</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co">#serialize bundles</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2">serialized_bundles &lt;-<span class="st"> </span><span class="kw">fhir_serialize</span>(patient_bundles)</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"></a>
<a class="sourceLine" id="cb23-4" data-line-number="4"><span class="co">#have a look at them</span></a>
<a class="sourceLine" id="cb23-5" data-line-number="5"><span class="kw">head</span>(serialized_bundles[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb23-6" data-line-number="6"><span class="co">#&gt; [1] 58 0a 00 00 00 03</span></a></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="co">#create temporary directory for saving</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2">temp_dir &lt;-<span class="st"> </span><span class="kw">tempdir</span>()</a>
<a class="sourceLine" id="cb24-3" data-line-number="3"></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="co">#save</span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="kw">save</span>(serialized_bundles, <span class="dt">file=</span><span class="kw">paste0</span>(temp_dir, <span class="st">&quot;/bundles.rda&quot;</span>))</a></code></pre></div>
<p>If you load this bundle again, you have to unserialize it before you can work with it:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co">#load bundles</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="kw">load</span>(<span class="kw">paste0</span>(temp_dir, <span class="st">&quot;/bundles.rda&quot;</span>))</a></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="co">#unserialize</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2">bundles &lt;-<span class="st"> </span><span class="kw">fhir_unserialize</span>(serialized_bundles)</a>
<a class="sourceLine" id="cb26-3" data-line-number="3"></a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="co">#have a look</span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5"><span class="kw">head</span>(bundles[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb26-6" data-line-number="6"><span class="co">#&gt; $node</span></a>
<a class="sourceLine" id="cb26-7" data-line-number="7"><span class="co">#&gt; &lt;pointer: 0x555da292d880&gt;</span></a>
<a class="sourceLine" id="cb26-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb26-9" data-line-number="9"><span class="co">#&gt; $doc</span></a>
<a class="sourceLine" id="cb26-10" data-line-number="10"><span class="co">#&gt; &lt;pointer: 0x555da795ed30&gt;</span></a></code></pre></div>
<p>After unserialization, the pointers are restored and you can continue to work with the bundles. Note that the example bundles <code>medication_bundles</code> and <code>patient_bundles</code> that are provided with the <code>fhircrackr</code> package are also provided in their serialized form and have to be unserialized as described on their help page.</p>
</div>
<div id="save-and-load-bundles-as-xml-files" class="section level3">
<h3>2. Save and load bundles as xml files</h3>
<p>If you want to store the bundles in xml files instead of R objects, you can use the functions <code>fhir_save()</code> and <code>fhir_load()</code>. <code>fhir_save()</code> takes a list of bundles in form of xml objects (as returned by <code>fhir_search()</code>) and writes them into the directory specified in the argument <code>directory</code>. Each bundle is saved as a separate xml-file. If the folder defined in <code>directory</code> doesn’t exist, it is created in the current working directory.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="co">#save bundles as xml files</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="kw">fhir_save</span>(patient_bundles, <span class="dt">directory=</span>temp_dir)</a></code></pre></div>
<p>To read bundles saved with <code>fhir_save()</code> back into R, you can use <code>fhir_load()</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">bundles &lt;-<span class="st"> </span><span class="kw">fhir_load</span>(temp_dir)</a></code></pre></div>
<p><code>fhir_load()</code> takes the name of the directory (or path to it) as its only argument. All xml-files in this directory will be read into R and returned as a list of bundles in xml format just as returned by <code>fhir_search()</code>.</p>
</div>
</div>
<div id="save-and-read-designs" class="section level2">
<h2>Save and read designs</h2>
<p>If you want to save a design for later or to share with others, you can do so using the <code>fhir_save_design()</code>. This function takes a design and saves it as an xml file:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw">fhir_save_design</span>(design1, <span class="dt">file =</span> <span class="kw">paste0</span>(temp_dir,<span class="st">&quot;/design.xml&quot;</span>))</a></code></pre></div>
<p>To read the design back into R, you can use <code>fhir_load_design()</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">fhir_load_design</span>(<span class="kw">paste0</span>(temp_dir,<span class="st">&quot;/design.xml&quot;</span>))</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="co">#&gt; $Patients</span></a>
<a class="sourceLine" id="cb30-3" data-line-number="3"><span class="co">#&gt; $Patients$resource</span></a>
<a class="sourceLine" id="cb30-4" data-line-number="4"><span class="co">#&gt; [1] &quot;//Patient&quot;</span></a>
<a class="sourceLine" id="cb30-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb30-6" data-line-number="6"><span class="co">#&gt; $Patients$cols</span></a>
<a class="sourceLine" id="cb30-7" data-line-number="7"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb30-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb30-9" data-line-number="9"><span class="co">#&gt; $Patients$style</span></a>
<a class="sourceLine" id="cb30-10" data-line-number="10"><span class="co">#&gt; $Patients$style$sep</span></a>
<a class="sourceLine" id="cb30-11" data-line-number="11"><span class="co">#&gt; [1] &quot; | &quot;</span></a>
<a class="sourceLine" id="cb30-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb30-13" data-line-number="13"><span class="co">#&gt; $Patients$style$brackets</span></a>
<a class="sourceLine" id="cb30-14" data-line-number="14"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb30-15" data-line-number="15"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb30-16" data-line-number="16"><span class="co">#&gt; $Patients$style$rm_empty_cols</span></a>
<a class="sourceLine" id="cb30-17" data-line-number="17"><span class="co">#&gt; [1] TRUE</span></a></code></pre></div>
</div>
<div id="performance" class="section level2">
<h2>Performance</h2>
<p>If you want to download a lot of resources from a server, you might run into several problems.</p>
<p>First of all, downloading a lot of resources will require a lot of time, depending on the performance of your FHIR server. Because <code>fhir_search()</code> essentially runs a loop pulling bundle after bundle, downloads can usually be accelerated if the bundle size is increased, because that way we can lower the number of requests to the server. You can achieve this by adding <code>_count=</code> parameter to your FHIR search request. <code>http://hapi.fhir.org/baseR4/Patient?_count=500</code> for example will pull patient resources in bundles of 500 resources from the server.</p>
<p>A problem that is also related to the number of requests to the server is that sometimes servers might crash, when too many requests are sent to them in a row. In that case <code>fhir_search()</code> will throw an error. If you set the argument <code>log_errors</code> accordingly, you can however retrieve the server errors that caused <code>fhir_search()</code> to crash.</p>
<p>The third problem is that large amounts of resources can at some point exceed the working memory you have available. There are two solutions to the problem of crashing servers and working memory:</p>
<div id="use-the-save_to_disc-argument-of-fhir_search" class="section level3">
<h3>1. Use the save_to_disc argument of fhir_search()</h3>
<p>If you set <code>save_to_disc=TRUE</code> in your call to fhir_search(), the bundles will not be combined in a bundle list that is returned when the downloading is done, but will instead be saved as xml-files to the directory specified in the argument <code>directory</code> one by one. This way, the R session will only have to keep one bundle at a time in the working memory and if the server crashes halfway trough, all bundles up to the crash are safely saved in your directory:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">fhir_search</span>(<span class="st">&quot;http://hapi.fhir.org/baseR4/Patient&quot;</span>, <span class="dt">max_bundles =</span> <span class="dv">10</span>, </a>
<a class="sourceLine" id="cb31-2" data-line-number="2">            <span class="dt">save_to_disc=</span><span class="ot">TRUE</span>, <span class="dt">directory =</span> <span class="kw">paste0</span>(temp_dir, <span class="st">&quot;/downloadedBundles&quot;</span>))</a></code></pre></div>
</div>
<div id="use-fhir_next_bundle_url" class="section level3">
<h3>2. Use fhir_next_bundle_url()</h3>
<p>Alternatively, you can also use <code>fhir_next_bundle_url()</code>. This function returns the url to the next bundle from you most recent call to <code>fhir_search()</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw">fhir_next_bundle_url</span>()</a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="co">#&gt; [1] &quot;http://hapi.fhir.org/baseR4?_getpages=0be4d713-a4db-4c27-b384-b772deabcbc4&amp;_getpagesoffset=200&amp;_count=20&amp;_pretty=true&amp;_bundletype=searchset&quot;</span></a></code></pre></div>
<p>To get a better overview, we can split this very long link along the <code>&amp;</code>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw">strsplit</span>(<span class="kw">fhir_next_bundle_url</span>(), <span class="st">&quot;&amp;&quot;</span>)</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="co">#&gt; [1] &quot;http://hapi.fhir.org/baseR4?_getpages=0be4d713-a4db-4c27-b384-b772deabcbc4&quot;</span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="co">#&gt; [2] &quot;_getpagesoffset=200&quot;                                                       </span></a>
<a class="sourceLine" id="cb33-5" data-line-number="5"><span class="co">#&gt; [3] &quot;_count=20&quot;                                                                 </span></a>
<a class="sourceLine" id="cb33-6" data-line-number="6"><span class="co">#&gt; [4] &quot;_pretty=true&quot;                                                              </span></a>
<a class="sourceLine" id="cb33-7" data-line-number="7"><span class="co">#&gt; [5] &quot;_bundletype=searchset&quot;</span></a></code></pre></div>
<p>You can see two interesting numbers: <code>_count=20</code> tells you that the queried hapi server has a default bundle size of 20. <code>getpagesoffset=200</code> tells you that the bundle referred to in this link starts after resource no. 200, which makes sense since the <code>fhir_search()</code> request above downloaded 10 bundles with 20 resources each, i.e. 200 resources. If you use this link in a new call to <code>fhir_search</code>, the download will start from this bundle (i.e. the 11th bundle with resources 201-220) and will go on to the following bundles from there.</p>
<p>When there is no next bundle (because all available resources have been downloaded), <code>fhir_next_bundle_url()</code> returns <code>NULL</code>.</p>
<p>If a download with <code>fhir_search()</code> is interrupted due to a server error somewhere in between, you can use <code>fhir_next_bundle_url()</code> to see where the download was interrupted.</p>
<p>You can also use this function to avoid memory issues. Th following block of code utilizes <code>fhir_next_bundle_url()</code> to download all available Observation resources in small batches of 10 bundles that are immediately cracked and saved before the next batch of bundles is downloaded. Note that this example can be very time consuming if there are a lot of resources on the server, to limit the number of iterations uncomment the lines of code that have been commented out here:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="co">#Starting fhir search request</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2">url &lt;-<span class="st"> &quot;http://hapi.fhir.org/baseR4/Observation?_count=500&quot;</span></a>
<a class="sourceLine" id="cb34-3" data-line-number="3"></a>
<a class="sourceLine" id="cb34-4" data-line-number="4"><span class="co">#count &lt;- 0</span></a>
<a class="sourceLine" id="cb34-5" data-line-number="5"></a>
<a class="sourceLine" id="cb34-6" data-line-number="6"><span class="cf">while</span>(<span class="op">!</span><span class="kw">is.null</span>(url)){</a>
<a class="sourceLine" id="cb34-7" data-line-number="7">    </a>
<a class="sourceLine" id="cb34-8" data-line-number="8">    <span class="co">#load 10 bundles</span></a>
<a class="sourceLine" id="cb34-9" data-line-number="9">    bundles &lt;-<span class="st"> </span><span class="kw">fhir_search</span>(url, <span class="dt">max_bundles =</span> <span class="dv">10</span>) </a>
<a class="sourceLine" id="cb34-10" data-line-number="10">    </a>
<a class="sourceLine" id="cb34-11" data-line-number="11">    <span class="co">#crack bundles</span></a>
<a class="sourceLine" id="cb34-12" data-line-number="12">    dfs &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(bundles, <span class="kw">list</span>(<span class="dt">Obs=</span><span class="kw">list</span>(<span class="dt">resource =</span> <span class="st">&quot;//Observation&quot;</span>)))</a>
<a class="sourceLine" id="cb34-13" data-line-number="13">    </a>
<a class="sourceLine" id="cb34-14" data-line-number="14">    <span class="co">#save cracked bundle to RData-file (can be exchanged by other data type)</span></a>
<a class="sourceLine" id="cb34-15" data-line-number="15">    <span class="kw">save</span>(tables, <span class="dt">file =</span> <span class="kw">paste0</span>(temp_dir,<span class="st">&quot;/table_&quot;</span>, count, <span class="st">&quot;.RData&quot;</span>))</a>
<a class="sourceLine" id="cb34-16" data-line-number="16">    </a>
<a class="sourceLine" id="cb34-17" data-line-number="17">    <span class="co">#retrieve starting point for next 10 bundles</span></a>
<a class="sourceLine" id="cb34-18" data-line-number="18">    url &lt;-<span class="st"> </span><span class="kw">fhir_next_bundle_url</span>()</a>
<a class="sourceLine" id="cb34-19" data-line-number="19">    </a>
<a class="sourceLine" id="cb34-20" data-line-number="20">    <span class="co">#count &lt;- count + 1</span></a>
<a class="sourceLine" id="cb34-21" data-line-number="21">    <span class="co">#if(count &gt;= 20) {break}</span></a>
<a class="sourceLine" id="cb34-22" data-line-number="22">}</a></code></pre></div>
</div>
</div>
<div id="download-capability-statement" class="section level2">
<h2>Download Capability Statement</h2>
<p>The <a href="https://www.hl7.org/fhir/capabilitystatement.html">capability statement</a> documents a set of capabilities (behaviors) of a FHIR Server for a particular version of FHIR. You can download this statement using the function <code>fhir_capability_statement()</code>:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">cap &lt;-<span class="st"> </span><span class="kw">fhir_capability_statement</span>(<span class="st">&quot;http://hapi.fhir.org/baseR4/&quot;</span>, <span class="dt">verbose =</span> <span class="dv">0</span>)</a></code></pre></div>
<p><code>fhir_capability_statement()</code> takes a FHIR server endpoint and returns a list of data frames containing all information from the capability statement of this server.</p>
</div>
<div id="further-options" class="section level2">
<h2>Further Options</h2>
<div id="extract-data-below-resource-level" class="section level3">
<h3>Extract data below resource level</h3>
<p>While we recommend extracting exactly one data frame per resource, it is technically possible to choose a different level per data frame:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">design &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb36-2" data-line-number="2">    <span class="dt">MedCodes=</span><span class="kw">list</span>(<span class="dt">resource =</span> <span class="st">&quot;//medicationCodeableConcept/coding&quot;</span>)</a>
<a class="sourceLine" id="cb36-3" data-line-number="3">)</a>
<a class="sourceLine" id="cb36-4" data-line-number="4"></a>
<a class="sourceLine" id="cb36-5" data-line-number="5">df &lt;-<span class="st"> </span><span class="kw">fhir_crack</span>(medication_bundles, design, <span class="dt">verbose=</span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb36-6" data-line-number="6"></a>
<a class="sourceLine" id="cb36-7" data-line-number="7"><span class="kw">head</span>(df<span class="op">$</span>MedCodes)</a>
<a class="sourceLine" id="cb36-8" data-line-number="8"><span class="co">#&gt;                  system      code          display</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9"><span class="co">#&gt; 1 http://snomed.info/ct 429374003 simvastatin 40mg</span></a>
<a class="sourceLine" id="cb36-10" data-line-number="10"><span class="co">#&gt; 2 http://snomed.info/ct 429374003 simvastatin 40mg</span></a>
<a class="sourceLine" id="cb36-11" data-line-number="11"><span class="co">#&gt; 3 http://snomed.info/ct 429374003 simvastatin 40mg</span></a>
<a class="sourceLine" id="cb36-12" data-line-number="12"><span class="co">#&gt; 4 http://snomed.info/ct 429374003 simvastatin 40mg</span></a>
<a class="sourceLine" id="cb36-13" data-line-number="13"><span class="co">#&gt; 5 http://snomed.info/ct 429374003 simvastatin 40mg</span></a>
<a class="sourceLine" id="cb36-14" data-line-number="14"><span class="co">#&gt; 6 http://snomed.info/ct 429374003 simvastatin 40mg</span></a></code></pre></div>
<p>The above example shows that instead of the MedicationStatement resource, we can choose the MedicationCodeableConcept as the root level for our extraction. This can be useful to get a quick and relatively clean overview over the types of codes used on this level of the resource. It is however important to note that this mode of extraction makes it impossible to recognize if each row belongs to one resource or if several of these rows came from the same resource. This of course also means that you cannot link this information to data from other resources because this extraction mode discards of that information.</p>
</div>
</div>
<div id="acknowledgements" class="section level2">
<h2>Acknowledgements</h2>
<p>This work was carried out by the SMITH consortium and the cross-consortium use case POLAR_MI; both are part of the German Initiative for Medical Informatics and funded by the German Federal Ministry of Education and Research (BMBF), grant no. 01ZZ1803A , 01ZZ1803C and 01ZZ1910A.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>FHIR is the registered trademark of HL7 and is used with the permission of HL7. Use of the FHIR trademark does not constitute endorsement of this product by HL7<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
