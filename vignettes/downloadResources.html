<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />


<meta name="date" content="2021-06-16" />

<title>fhircrackr: Download FHIR resources</title>

<script src="data:application/javascript;base64,Ly8gUGFuZG9jIDIuOSBhZGRzIGF0dHJpYnV0ZXMgb24gYm90aCBoZWFkZXIgYW5kIGRpdi4gV2UgcmVtb3ZlIHRoZSBmb3JtZXIgKHRvCi8vIGJlIGNvbXBhdGlibGUgd2l0aCB0aGUgYmVoYXZpb3Igb2YgUGFuZG9jIDwgMi44KS4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUpIHsKICB2YXIgaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuc2VjdGlvbltjbGFzcyo9J2xldmVsJ10gPiA6Zmlyc3QtY2hpbGQiKTsKICB2YXIgaSwgaCwgYTsKICBmb3IgKGkgPSAwOyBpIDwgaHMubGVuZ3RoOyBpKyspIHsKICAgIGggPSBoc1tpXTsKICAgIGlmICghL15oWzEtNl0kL2kudGVzdChoLnRhZ05hbWUpKSBjb250aW51ZTsgIC8vIGl0IHNob3VsZCBiZSBhIGhlYWRlciBoMS1oNgogICAgYSA9IGguYXR0cmlidXRlczsKICAgIHdoaWxlIChhLmxlbmd0aCA+IDApIGgucmVtb3ZlQXR0cmlidXRlKGFbMF0ubmFtZSk7CiAgfQp9KTsK"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="data:text/css,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">fhircrackr: Download FHIR resources</h1>
<h4 class="date">2021-06-16</h4>



<p>This vignette covers the following topics:</p>
<ul>
<li><p>Building FHIR search requests</p></li>
<li><p>Downloading resources from a FHIR server</p></li>
<li><p>Authentication</p></li>
<li><p>Search via POST</p></li>
<li><p>Dealing with HTTP errors</p></li>
<li><p>Saving the downloaded bundles</p></li>
<li><p>Dealing with large data sets</p></li>
<li><p>Downloading the capability statement</p></li>
</ul>
<p>Before running any of the following code, you need to load the <code>fhircrackr</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fhircrackr)</span></code></pre></div>
<div id="fhir-search-requests" class="section level2">
<h2>FHIR search requests</h2>
<p>To download FHIR resources from the server, you need to specify which resources you want with a <em>FHIR search request</em>. If you are already familiar with the topic and prefer writing your FHIR search request yourself, you can just define your search request as a simple string that you provide to <code>fhir_search()</code>. In that case, however, no checking of spelling mistakes of resource types and URL encoding will be done for you. If you are comfortable with this, you can skip the following paragraph, as the first part of this vignette introduces the basics of FHIR search and some functions to build valid FHIR search requests with <code>fhircrackr</code>.</p>
<p>A FHIR search request will mostly have the form <code>[base]/[type]?parameter(s)</code>, where <code>[base]</code> is the base URL to the FHIR server you are trying to access, <code>[type]</code> refers to the type of resource you are looking for and <code>parameter(s)</code> characterize specific properties those resources should have. The function <code>fhir_url()</code> offers a solution to bring those three components together correctly, taking care of proper formatting for you.</p>
<p>In the simplest case, <code>fhir_url()</code> takes only the base url and the resource type you are looking for like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fhir_url</span>(<span class="at">url =</span> <span class="st">&quot;http://hapi.fhir.org/baseR4&quot;</span>, <span class="at">resource =</span> <span class="st">&quot;Patient&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># An object of class &quot;fhir_url&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] &quot;http://hapi.fhir.org/baseR4/Patient&quot;</span></span></code></pre></div>
<p>Internally, <code>fhir_resource_type</code> is called to check the type you provided against list of all currently available resource types can be found at <a href="https://hl7.org/FHIR/resourcelist.html" target="_blank">https://hl7.org/FHIR/resourcelist.html</a>. Case errors are corrected automatically and the function throws a warning, if the resource type doesn’t match the list under hl7.org:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fhir_resource_type</span>(<span class="at">string =</span> <span class="st">&quot;Patient&quot;</span>) <span class="co">#correct</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># A fhir_resource_type object:  Patient</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">fhir_resource_type</span>(<span class="at">string =</span> <span class="st">&quot;medicationstatement&quot;</span>) <span class="co">#fixed</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Changing resource type &quot;medicationstatement&quot; into &quot;MedicationStatement&quot;.</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># A fhir_resource_type object:  MedicationStatement</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">fhir_resource_type</span>(<span class="at">string =</span> <span class="st">&quot;medicationstatement&quot;</span>, <span class="at">fix_capitalization =</span> <span class="cn">FALSE</span>) <span class="co">#not fixed</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># A fhir_resource_type object:  medicationstatement</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">fhir_resource_type</span>(<span class="at">string =</span> <span class="st">&quot;Hospital&quot;</span>) <span class="co">#an unknown resource type, a warning is issued</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># A fhir_resource_type object:  Hospital</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Warnmeldung:</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># In fhir_resource_type(&quot;Hospital&quot;) :</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   You gave &quot;Hospital&quot; as the resource type.</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># This doesn&#39;t match any of the resource types defined under</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># https://hl7.org/FHIR/resourcelist.html.</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># If you are sure the resource type is correct anyway, you can ignore this warning.</span></span></code></pre></div>
<p>Beside telling the server which resource type to give back, the resource type also determines the kinds of search parameters that are allowed. Search parameters are use to further qualify the resources you want to get back, e.g by restricting the search result to Patient resources of female patients only.</p>
<p>You can add zero, one, or multiple search parameters to the request. If you don’t give any parameters, the search will just return all resources of the specified type from the server. Search parameters generally come in the form <code>key = value</code>. There are a number of resource independent parameters that can be found under <a href="https://www.hl7.org/fhir/search.html#Summary" target="_blank">https://www.hl7.org/fhir/search.html#Summary</a>. These parameters usually have a <code>_</code> at the beginning. <code>&quot;_sort&quot; = &quot;status&quot;</code> for examples sorts the results by their status, <code>&quot;_include&quot; = &quot;Observation:patient&quot;</code>, will include the linked Patient resources in a search for Observation resources.</p>
<p>Apart from the resource independent parameters, there are also resource dependent parameters referring to elements specific to that resource. These parameters come without a <code>_</code> and you can find a list of them at the end of every resource site e.g. at <a href="https://www.hl7.org/fhir/patient.html#search" target="_blank">https://www.hl7.org/fhir/patient.html#search</a> for the Patient resource. An example of such a parameter would be <code>&quot;birthdate&quot; = &quot;lt2000-01-01&quot;</code> for patients born before the year 2000 or <code>&quot;gender&quot; = &quot;female&quot;</code> to get female patients only.</p>
<p>You can add search parameters to your request via a named list or a named character vector:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>request <span class="ot">&lt;-</span> <span class="fu">fhir_url</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">url        =</span> <span class="st">&quot;http://hapi.fhir.org/baseR4&quot;</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">resource   =</span> <span class="st">&quot;Patient&quot;</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">parameters =</span> <span class="fu">list</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;birthdate&quot;</span> <span class="ot">=</span> <span class="st">&quot;lt2000-01-01&quot;</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;code&quot;</span>      <span class="ot">=</span> <span class="st">&quot;http://loinc.org|1751-1&quot;</span>))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>request</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># An object of class &quot;fhir_url&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] &quot;http://hapi.fhir.org/baseR4/Patient?birthdate=lt2000-01-01&amp;code=http://</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># loinc.org%7C1751-1&quot;</span></span></code></pre></div>
<p>As you can see, <code>fhir_url()</code> performs automatic url encoding and the <code>|</code> is transformed to <code>%7C</code>.</p>
<div id="accessing-the-current-request" class="section level3">
<h3>Accessing the current request</h3>
<p>Whenever you call <code>fhir_url()</code> or <code>fhir_search()</code>, the corresponding FHIR search request will be saved implicitly and can be accessed with <code>fhir_current_request()</code></p>
<p>If you call <code>fhir_search()</code> without providing an explicit request, the function will automatically call <code>fhir_current_request()</code>.</p>
</div>
</div>
<div id="download-fhir-resources-from-a-server" class="section level2">
<h2>Download FHIR resources from a server</h2>
<p>To download resources from a server, you use the function <code>fhir_search()</code> and provide a FHIR search request.</p>
<div id="basic-request" class="section level3">
<h3>Basic request</h3>
<p>We will start with a very simple example and use <code>fhir_search()</code> to download Patient resources from a public HAPI server:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>request <span class="ot">&lt;-</span> <span class="fu">fhir_url</span>(<span class="at">url =</span> <span class="st">&quot;https://hapi.fhir.org/baseR4&quot;</span>, <span class="at">resource =</span> <span class="st">&quot;Patient&quot;</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>patient_bundles <span class="ot">&lt;-</span> <span class="fu">fhir_search</span>(<span class="at">request =</span> request, <span class="at">max_bundles =</span> <span class="dv">2</span>, <span class="at">verbose =</span> <span class="dv">0</span>)</span></code></pre></div>
<p>In general, a FHIR search request returns a <em>bundle</em> of the resources you requested. If there are a lot of resources matching your request, the search result isn’t returned in one big bundle but distributed over several of them, sometimes called <em>pages</em>, the size of which is determined by the FHIR server. If the argument <code>max_bundles</code> is set to its default <code>Inf</code>, <code>fhir_search()</code> will return all available bundles/pages, meaning all resources matching your request. If you set it to <code>2</code> as in the example above, the download will stop after the first two bundles. Note that in this case, the result <em>may not contain all</em> the resources from the server matching your request, but it can be useful to first look at the first couple of search results before you download all of them.</p>
<p>If you want to connect to a FHIR server that uses basic authentication, you can supply the arguments <code>username</code> and <code>password</code>. If the server uses some bearer token authentication, you can provide the token in the argument <code>token</code>. See below for more information on authentication.</p>
<p>Because servers can sometimes be hard to reach, <code>fhir_search()</code> will start five attempts to connect to the server before it gives up. With the arguments <code>max_attempts</code> and <code>delay_between_attempts</code> you can control this number as well the time interval between attempts.</p>
<p>As you can see in the next block of code, <code>fhir_search()</code> returns an object of class <code>fhir_bundle_list</code> where each element represents one bundle of resources, so a list of two in our case:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>patient_bundles</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># An object of class &quot;fhir_bundle_list&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [[1]]</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># A fhir_bundle_xml object</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of entries : 20</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Self Link: http://hapi.fhir.org/baseR4/Patient</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Next Link: http://hapi.fhir.org/baseR4?_getpages=ce958386-53d0-4042-888c-cad53bf5d5a1 ...</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># {xml_node}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;Bundle&gt;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#  [1] &lt;id value=&quot;ce958386-53d0-4042-888c-cad53bf5d5a1&quot;/&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#  [2] &lt;meta&gt;\n  &lt;lastUpdated value=&quot;2021-05-10T12:12:43.317+00:00&quot;/&gt;\n&lt;/meta&gt;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  [3] &lt;type value=&quot;searchset&quot;/&gt;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#  [4] &lt;link&gt;\n  &lt;relation value=&quot;self&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.org/b ...</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">#  [5] &lt;link&gt;\n  &lt;relation value=&quot;next&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.org/b ...</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">#  [6] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837602&quot;/ ...</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  [7] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/example-r ...</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co">#  [8] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837624&quot;/ ...</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  [9] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837626&quot;/ ...</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># [10] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837631&quot;/ ...</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># [11] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837716&quot;/ ...</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># [12] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837720&quot;/ ...</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># [13] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837714&quot;/ ...</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co"># [14] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837721&quot;/ ...</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co"># [15] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837722&quot;/ ...</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># [16] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837723&quot;/ ...</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># [17] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837724&quot;/ ...</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="co"># [18] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/cfsb16116 ...</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># [19] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837736&quot;/ ...</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># [20] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837737&quot;/ ...</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># [[2]]</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co"># A fhir_bundle_xml object</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of entries : 20</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Self Link: http://hapi.fhir.org/baseR4?_getpages=ce958386-53d0-4042-888c-cad53bf5d5a1 ...</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Next Link: http://hapi.fhir.org/baseR4?_getpages=ce958386-53d0-4042-888c-cad53bf5d5a1 ...</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="co"># {xml_node}</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;Bundle&gt;</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="co">#  [1] &lt;id value=&quot;ce958386-53d0-4042-888c-cad53bf5d5a1&quot;/&gt;</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="co">#  [2] &lt;meta&gt;\n  &lt;lastUpdated value=&quot;2021-05-10T12:12:43.317+00:00&quot;/&gt;\n&lt;/meta&gt;</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="co">#  [3] &lt;type value=&quot;searchset&quot;/&gt;</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="co">#  [4] &lt;link&gt;\n  &lt;relation value=&quot;self&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.org/b ...</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="co">#  [5] &lt;link&gt;\n  &lt;relation value=&quot;next&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.org/b ...</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="co">#  [6] &lt;link&gt;\n  &lt;relation value=&quot;previous&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.o ...</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a><span class="co">#  [7] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837760&quot;/ ...</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="co">#  [8] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837766&quot;/ ...</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a><span class="co">#  [9] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837768&quot;/ ...</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="co"># [10] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837781&quot;/ ...</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="co"># [11] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837783&quot;/ ...</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a><span class="co"># [12] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837784&quot;/ ...</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="co"># [13] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837787&quot;/ ...</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="co"># [14] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837788&quot;/ ...</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="co"># [15] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837789&quot;/ ...</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="co"># [16] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837790&quot;/ ...</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="co"># [17] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837791&quot;/ ...</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a><span class="co"># [18] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837792&quot;/ ...</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="co"># [19] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837793&quot;/ ...</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="co"># [20] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837794&quot;/ ...</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span></code></pre></div>
<p>If for some reason you cannot connect to a FHIR server at the moment but want to explore the bundles anyway, the package provides an example list of bundles containing Patient resources. See <code>?patient_bundles</code> for how to use it.</p>
</div>
<div id="more-than-one-resource-type" class="section level3">
<h3>More than one resource type</h3>
<p>In many cases, you will want to download different types of FHIR resources belonging together. For example you might want to download all MedicationStatement resources with the snomed code <code>429374003</code> and also download the Patient resources these MedicationStatements refer to. The FHIR search request to do this can be built like this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>request <span class="ot">&lt;-</span> <span class="fu">fhir_url</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">url        =</span> <span class="st">&quot;https://hapi.fhir.org/baseR4/&quot;</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">resource   =</span> <span class="st">&quot;MedicationStatement&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">parameters =</span> <span class="fu">list</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;code&quot;</span>     <span class="ot">=</span> <span class="st">&quot;http://snomed.info/ct|429374003&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;_include&quot;</span> <span class="ot">=</span> <span class="st">&quot;MedicationStatement:subject&quot;</span>))</span></code></pre></div>
<p>Then you provide the request to <code>fhir_search()</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>medication_bundles <span class="ot">&lt;-</span> <span class="fu">fhir_search</span>(<span class="at">request =</span> request, <span class="at">max_bundles =</span> <span class="dv">3</span>)</span></code></pre></div>
<p>These bundles now contain two types of resources, MedicationStatement resources as well as Patient resources. If you want to have a look at the bundles, it is not very useful to print them to the console. Instead just save them as xml-files to a directory of you choice and look at the resources there:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fhir_save</span>(<span class="at">bundles =</span> medication_bundles, <span class="at">directory =</span> <span class="st">&quot;MyProject/medicationBundles&quot;</span>)</span></code></pre></div>
<p>If you want to have a look at a bundle like this but don’t have access to a FHIR server at the moment, check out <code>?medication_bundles</code>.</p>
</div>
</div>
<div id="authentication" class="section level2">
<h2>Authentication</h2>
<p>If your FHIR server is protected with some kind of bearer token authentication, <code>fhir_search()</code> lets you provide the token as a string or as an object of class <code>Token</code> from the <code>httr</code> package. You can use <code>fhir_authenticate()</code> to create a token generated by an OAuth2/OpenID Connect process. See <code>?fhir_authenticate</code> for more information on that topic.</p>
</div>
<div id="search-via-post" class="section level2">
<h2>Search via POST</h2>
<p>The default behaviour of <code>fhir_search()</code> is to send the FHIR search request as a <code>GET</code> request to the server. In some special cases, however, it can be useful to use the <code>POST</code> based search described <a href="https://www.hl7.org/fhir/search.html#Introduction" target="_blank">here</a> instead. This is mostly the case when the URL of you FHIR search request gets long enough to exceed the allowed url length. A common scenario for this would be a request querying an explicit list of identifiers. Let’s for example say you are looking for the following list of patient identifiers:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;72622884-0a09-4ea9-9a91-685bce3b0fe3&quot;</span>, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;2ca48b68-a641-4be7-a39d-9ffe2691a29a&quot;</span>, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;8bcdd92d-5f96-4e07-9f6a-e22a3591ee30&quot;</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;2067558f-c9ed-489a-9c2f-7387bb3426a2&quot;</span>, </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;5077b4b0-07c9-4d03-b9ec-1f9f218f8239&quot;</span>)</span></code></pre></div>
<p>You can use them comma separated in the value of the <code>identifier</code> search parameter like this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>id_strings <span class="ot">&lt;-</span> <span class="fu">paste</span>(ids, <span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>)</span></code></pre></div>
<p>But this string would make the FHIR search request URL very long, especially if it is combined with additional other search parameters.</p>
<p>In a search via POST, the search parameters (everything that would usually follow the resource type after the ?) can be transferred to a body of type <code>application/x-www-form-urlencoded</code> and sent via POST. A body of this kind can be created the same way the parameters are usually given to the <code>parameters</code> argument of <code>fhir_url()</code>, i.e. as a named list or character:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#note the list()-expression</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>body <span class="ot">&lt;-</span> <span class="fu">fhir_body</span>(<span class="at">content =</span> <span class="fu">list</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;identifier&quot;</span>  <span class="ot">=</span> id_strings,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;_revinclude&quot;</span> <span class="ot">=</span> <span class="st">&quot;Observation:patient&quot;</span>))</span></code></pre></div>
<p>The body will then automatically be assigned the content type <code>application/x-www-form-urlencoded</code>. If you provide a body like this in <code>fhir_search()</code>, the url in request should <strong>only</strong> contain the base URL and the resource type. The function will automatically amend it with the suffix <code>_search</code> and perform a POST:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">fhir_url</span>(<span class="at">url =</span> <span class="st">&quot;https://hapi.fhir.org/baseR4/&quot;</span>, <span class="at">resource =</span> <span class="st">&quot;Patient&quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>bundles <span class="ot">&lt;-</span> <span class="fu">fhir_search</span>(<span class="at">request =</span> url, <span class="at">body =</span> body)</span></code></pre></div>
</div>
<div id="dealing-with-http-errors" class="section level2">
<h2>Dealing with HTTP Errors</h2>
<p><code>fhir_search()</code> internally sends a <code>GET</code> or <code>POST</code> request to the server. If anything goes wrong, e.g. because your request wasn’t valid or the server caused an error, the result of you request will be a HTTP error. <code>fhir_search()</code> will print the error code along with some suggestions for the most common errors to the console.</p>
<p>To get more detailed information on the error response, you can pass a string with a file name to the argument <code>log_errors</code> . This will write a log with error information to the specified file.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>medication_bundles <span class="ot">&lt;-</span> <span class="fu">fhir_search</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">request     =</span> request,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_bundles =</span> <span class="dv">3</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_errors  =</span> <span class="st">&quot;myErrorFile&quot;</span>)</span></code></pre></div>
</div>
<div id="saving-the-downloaded-bundles" class="section level2">
<h2>Saving the downloaded bundles</h2>
<p>There are two ways of saving the FHIR bundles you downloaded: Either you save them as R objects, or you write them to an xml file. This is possible while downloading the bundles or after all bundles have been downloaded. The following section covers saving after downloading. See the <strong>Dealing with large data sets</strong> section for how to save bundles during downloading.</p>
<div id="save-bundles-as-r-objects" class="section level3">
<h3>Save bundles as R objects</h3>
<p>If you want to save the list of downloaded bundles as an <code>.rda</code> or <code>.RData</code> file, you can’t just use R’s <code>save()</code> or <code>save_image()</code> on it, because this will break the external pointers in the xml objects representing your bundles. Instead, you have to serialize the bundles before saving and unserialize them after loading. For single xml objects the package <code>xml2</code> provides serialization functions. For convenience, however, <code>fhircrackr</code> provides the functions <code>fhir_serialize()</code> and <code>fhir_unserialize()</code> that can be used directly on the bundles returned by <code>fhir_search()</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#serialize bundles</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>serialized_bundles <span class="ot">&lt;-</span> <span class="fu">fhir_serialize</span>(<span class="at">bundles =</span> patient_bundles)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#have a look at them</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(serialized_bundles[[<span class="dv">1</span>]])</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 58 0a 00 00 00 03</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create temporary directory for saving</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>temp_dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#save</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(serialized_bundles, <span class="at">file =</span> <span class="fu">paste0</span>(temp_dir, <span class="st">&quot;/bundles.rda&quot;</span>))</span></code></pre></div>
<p>If you load this bundle again, you have to unserialize it before you can work with it:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#load bundles</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(temp_dir, <span class="st">&quot;/bundles.rda&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#unserialize</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>bundles <span class="ot">&lt;-</span> <span class="fu">fhir_unserialize</span>(<span class="at">bundles =</span> serialized_bundles)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#have a look</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>bundles</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># An object of class &quot;fhir_bundle_list&quot;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [[1]]</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># A fhir_bundle_xml object</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of entries : 20</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Self Link: http://hapi.fhir.org/baseR4/Patient</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Next Link: http://hapi.fhir.org/baseR4?_getpages=ce958386-53d0-4042-888c-cad53bf5d5a1 ...</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># {xml_node}</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;Bundle&gt;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">#  [1] &lt;id value=&quot;ce958386-53d0-4042-888c-cad53bf5d5a1&quot;/&gt;</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">#  [2] &lt;meta&gt;\n  &lt;lastUpdated value=&quot;2021-05-10T12:12:43.317+00:00&quot;/&gt;\n&lt;/meta&gt;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  [3] &lt;type value=&quot;searchset&quot;/&gt;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">#  [4] &lt;link&gt;\n  &lt;relation value=&quot;self&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.org/b ...</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  [5] &lt;link&gt;\n  &lt;relation value=&quot;next&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.org/b ...</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">#  [6] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837602&quot;/ ...</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">#  [7] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/example-r ...</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co">#  [8] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837624&quot;/ ...</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co">#  [9] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837626&quot;/ ...</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co"># [10] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837631&quot;/ ...</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co"># [11] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837716&quot;/ ...</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co"># [12] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837720&quot;/ ...</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># [13] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837714&quot;/ ...</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co"># [14] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837721&quot;/ ...</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co"># [15] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837722&quot;/ ...</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="co"># [16] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837723&quot;/ ...</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co"># [17] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837724&quot;/ ...</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co"># [18] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/cfsb16116 ...</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co"># [19] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837736&quot;/ ...</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="co"># [20] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837737&quot;/ ...</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="co"># [[2]]</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co"># A fhir_bundle_xml object</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of entries : 20</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Self Link: http://hapi.fhir.org/baseR4?_getpages=ce958386-53d0-4042-888c-cad53bf5d5a1 ...</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Next Link: http://hapi.fhir.org/baseR4?_getpages=ce958386-53d0-4042-888c-cad53bf5d5a1 ...</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="co"># {xml_node}</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt;Bundle&gt;</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="co">#  [1] &lt;id value=&quot;ce958386-53d0-4042-888c-cad53bf5d5a1&quot;/&gt;</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="co">#  [2] &lt;meta&gt;\n  &lt;lastUpdated value=&quot;2021-05-10T12:12:43.317+00:00&quot;/&gt;\n&lt;/meta&gt;</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="co">#  [3] &lt;type value=&quot;searchset&quot;/&gt;</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="co">#  [4] &lt;link&gt;\n  &lt;relation value=&quot;self&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.org/b ...</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="co">#  [5] &lt;link&gt;\n  &lt;relation value=&quot;next&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.org/b ...</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="co">#  [6] &lt;link&gt;\n  &lt;relation value=&quot;previous&quot;/&gt;\n  &lt;url value=&quot;http://hapi.fhir.o ...</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="co">#  [7] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837760&quot;/ ...</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="co">#  [8] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837766&quot;/ ...</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="co">#  [9] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837768&quot;/ ...</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="co"># [10] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837781&quot;/ ...</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="co"># [11] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837783&quot;/ ...</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="co"># [12] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837784&quot;/ ...</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="co"># [13] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837787&quot;/ ...</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="co"># [14] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837788&quot;/ ...</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="co"># [15] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837789&quot;/ ...</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="co"># [16] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837790&quot;/ ...</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="co"># [17] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837791&quot;/ ...</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="co"># [18] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837792&quot;/ ...</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="co"># [19] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837793&quot;/ ...</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a><span class="co"># [20] &lt;entry&gt;\n  &lt;fullUrl value=&quot;http://hapi.fhir.org/baseR4/Patient/1837794&quot;/ ...</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span></code></pre></div>
<p>After unserialization, the pointers are restored and you can continue to work with the bundles. Note that the example bundles <code>medication_bundles</code> and <code>patient_bundles</code> that are provided with the <code>fhircrackr</code> package are also provided in their serialized form and have to be unserialized as described on their help page.</p>
</div>
<div id="save-and-load-bundles-as-xml-files" class="section level3">
<h3>Save and load bundles as xml files</h3>
<p>If you want to store the bundles in xml files instead of R objects, you can use the functions <code>fhir_save()</code> and <code>fhir_load()</code>. <code>fhir_save()</code> takes a list of bundles in form of xml objects (as returned by <code>fhir_search()</code>) and writes them into the directory specified in the argument <code>directory</code>. Each bundle is saved as a separate xml-file. If the folder defined in <code>directory</code> doesn’t exist, it is created in the current working directory.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save bundles as xml files</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fhir_save</span>(<span class="at">bundles =</span> patient_bundles, <span class="at">directory =</span> temp_dir)</span></code></pre></div>
<p>To read bundles saved with <code>fhir_save()</code> back into R, you can use <code>fhir_load()</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>bundles <span class="ot">&lt;-</span> <span class="fu">fhir_load</span>(<span class="at">directory =</span> temp_dir)</span></code></pre></div>
<p><code>fhir_load()</code> takes the name of the directory (or path to it) as its only argument. All xml-files in this directory will be read into R and returned as a list of bundles in xml format just as returned by <code>fhir_search()</code>.</p>
</div>
</div>
<div id="dealing-with-large-data-sets" class="section level2">
<h2>Dealing with large data sets</h2>
<p>If you want to download a lot of resources from a server, you might run into several problems.</p>
<p>First of all, downloading a lot of resources will require a lot of time, depending on the performance of your FHIR server. Because <code>fhir_search()</code> essentially runs a loop pulling bundle after bundle, downloads can usually be accelerated if the bundle size is increased, because that way we can lower the number of requests to the server. You can achieve this by adding <code>_count=</code> parameter to your FHIR search request. <code>http://hapi.fhir.org/baseR4/Patient?_count=500</code> for example will pull patient resources in bundles of 500 resources from the server.</p>
<p>A problem that is also related to the number of requests to the server is that sometimes servers might crash when too many requests are sent to them in a row. The third problem is that large amounts of resources can at some point exceed the working memory you have available. There are two solutions to the problem of crashing servers and working memory:</p>
<div id="use-the-save_to_disc-argument-of-fhir_search" class="section level3">
<h3>1. Use the save_to_disc argument of fhir_search()</h3>
<p>If you pass the name of a directory to the argument <code>save_to_disc</code> in your call to <code>fhir_search()</code>, the bundles will not be combined in a bundle list that is returned when the downloading is done, but will instead be saved as xml-files to the directory specified in the argument <code>directory</code> one by one. If the directory you specified doesn’t exist yet, <code>fhir_search()</code> will create it for you. This way, the R session will only have to keep one bundle at a time in the working memory and if the server crashes halfway trough, all bundles up to the crash are safely saved in your directory. You can later load them using <code>fhir_load()</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>request <span class="ot">&lt;-</span> <span class="fu">fhir_url</span>(<span class="at">url =</span> <span class="st">&quot;http://hapi.fhir.org/baseR4&quot;</span>, <span class="at">resource =</span> <span class="st">&quot;Patient&quot;</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fhir_search</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">request      =</span> request,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_bundles  =</span> <span class="dv">10</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">save_to_disc =</span> <span class="st">&quot;MyProject/downloadedBundles&quot;</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>bundles<span class="ot">&lt;-</span> <span class="fu">fhir_load</span>(<span class="at">directory =</span> <span class="st">&quot;MyProject/downloadedBundles&quot;</span>)</span></code></pre></div>
</div>
<div id="use-fhir_next_bundle_url" class="section level3">
<h3>2. Use fhir_next_bundle_url()</h3>
<p>Alternatively, you can also use <code>fhir_next_bundle_url()</code>. This function returns the url to the next bundle from you most recent call to <code>fhir_search()</code>:</p>
<p>To get a better overview, we can split this very long link along the <code>&amp;</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">strsplit</span>(<span class="fu">fhir_next_bundle_url</span>(), <span class="st">&quot;&amp;&quot;</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [[1]]</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] &quot;http://hapi.fhir.org/baseR4?_getpages=0be4d713-a4db-4c27-b384-b772deabcbc4&quot;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [2] &quot;_getpagesoffset=200&quot;                                                       </span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># [3] &quot;_count=20&quot;                                                                 </span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># [4] &quot;_pretty=true&quot;                                                              </span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [5] &quot;_bundletype=searchset&quot;</span></span></code></pre></div>
<p>You can see two interesting numbers: <code>_count=20</code> tells you that the queried hapi server has a default bundle size of 20. <code>getpagesoffset=200</code> tells you that the bundle referred to in this link starts after resource no. 200, which makes sense since the <code>fhir_search()</code> request above downloaded 10 bundles with 20 resources each, i.e. 200 resources. If you use this link in a new call to <code>fhir_search</code>, the download will start from this bundle (i.e. the 11th bundle with resources 201-220) and will go on to the following bundles from there.</p>
<p>When there is no next bundle (because all available resources have been downloaded), <code>fhir_next_bundle_url()</code> returns <code>NULL</code>.</p>
<p>If a download with <code>fhir_search()</code> is interrupted due to a server error somewhere in between, you can use <code>fhir_next_bundle_url()</code> to see where the download was interrupted.</p>
<p>You can also use this function to avoid memory issues. Th following block of code utilizes <code>fhir_next_bundle_url()</code> to download all available Observation resources in small batches of 10 bundles that are immediately cracked and saved before the next batch of bundles is downloaded. Note that this example can be very time consuming if there are a lot of resources on the server, to limit the number of iterations uncomment the lines of code that have been commented out here:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Starting fhir search request</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">fhir_url</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">url        =</span> <span class="st">&quot;http://hapi.fhir.org/baseR4&quot;</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">resource   =</span> <span class="st">&quot;Observation&quot;</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">parameters =</span> <span class="fu">list</span>(<span class="st">&quot;_count&quot;</span> <span class="ot">=</span> <span class="st">&quot;500&quot;</span>))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">#count &lt;- 0</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>table_description <span class="ot">&lt;-</span> <span class="fu">fhir_table_description</span>(<span class="at">resource =</span> <span class="st">&quot;Observation&quot;</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>(<span class="sc">!</span><span class="fu">is.null</span>(url)){</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#load 10 bundles</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    bundles <span class="ot">&lt;-</span> <span class="fu">fhir_search</span>(<span class="at">request =</span> url, <span class="at">max_bundles =</span> <span class="dv">10</span>) </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#crack bundles</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    dfs <span class="ot">&lt;-</span> <span class="fu">fhir_crack</span>(<span class="at">bundles =</span> bundles, <span class="at">design =</span> table_description)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#save cracked bundle to RData-file (can be exchanged by other data type)</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(tables, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;/table_&quot;</span>, count, <span class="st">&quot;.RData&quot;</span>))</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#retrieve starting point for next 10 bundles</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    url <span class="ot">&lt;-</span> <span class="fu">fhir_next_bundle_url</span>()</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># count &lt;- count + 1</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if(count &gt;= 20) {break}</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="download-capability-statement" class="section level2">
<h2>Download Capability Statement</h2>
<p>The <a href="https://www.hl7.org/fhir/capabilitystatement.html" target="_blank">capability statement</a> documents a set of capabilities (behaviors) of a FHIR Server for a particular version of FHIR. You can download this statement using the function <code>fhir_capability_statement()</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>cap <span class="ot">&lt;-</span> <span class="fu">fhir_capability_statement</span>(<span class="at">url =</span> <span class="st">&quot;http://hapi.fhir.org/baseR4&quot;</span>, <span class="at">verbose =</span> <span class="dv">0</span>)</span></code></pre></div>
<p><code>fhir_capability_statement()</code> takes the base URL of a FHIR server and returns a list of three data frames containing all information from the capability statement of this server. The first one is called <code>Meta</code> and contains some general server information. The second is called <code>Rest</code> and contains information on the operations the server implements. The third is called <code>resources</code> and gives information on the resource types and associated parameters the server supports. This information can be useful to determine, for example, which FHIR search parameters are implemented in you FHIR server.</p>
</div>
<div id="next-steps" class="section level2">
<h2>Next steps</h2>
<p>To learn about how <code>fhircrackr</code> allows you to convert the downloaded FHIR resources into data.frames/data.tables, see the vignette on flattening FHIR resources.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
